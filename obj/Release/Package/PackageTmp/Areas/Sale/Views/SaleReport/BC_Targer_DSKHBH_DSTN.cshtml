@using Erp.BackOffice.App_GlobalResources
@using Erp.BackOffice.Helpers
@using Erp.BackOffice.Sale.Models
@using Erp.BackOffice.Areas.Cms.Models
@{
    ViewBag.Title = "Theo dõi kế hoạch nhân viên (Target-DSKHBH-DSTN)";
    Layout = "~/Views/Shared/ACE_AdminLayout.cshtml";
    Erp.BackOffice.Models.PageSetting pageSetting = new Erp.BackOffice.Models.PageSetting
    {
        ModuleName = "SaleReport",
        ActionName = "BC_Targer_DSKHBH_DSTN",
        PageTitle = ViewBag.Title,
        DisplaySearchPanel = true,
        IsPopup = false,
        DisplayBackButton = false,
        SearchButtonText = "Xem báo cáo"
    };
    IEnumerable<Erp.BackOffice.Areas.Administration.Models.UserViewModel> user2 = (IEnumerable<Erp.BackOffice.Areas.Administration.Models.UserViewModel>)ViewBag.user2;
    var nguoilapid = Request["NGUOILAP"];
    var month = Request["month"] == null ? DateTime.Now.Month.ToString() : Request["month"];
    var year = Request["year"] == null ? DateTime.Now.Year.ToString() : Request["year"];
    IEnumerable<CategoryViewModel> origin = (IEnumerable<CategoryViewModel>)ViewBag.category;
    var FirstOrigin = Request["countForBrand"] == null ? origin.FirstOrDefault().Value : Request["countForBrand"];
    var listtarget = ViewBag.TargetKHBH_KHTN as Target_DSKHBH_DSTN_ViewModel;
    var listL1_L6 = ViewBag.L1_L6 as List<L1_L6_DSKHBH_DSTN_ViewModel>;
    var KHBH = listL1_L6.Where(x => x.A == "A").FirstOrDefault();
    var KHTN = listL1_L6.Where(x => x.A == "B").FirstOrDefault();
    decimal? tong = (KHBH.L1 + KHBH.L2 + KHBH.L3 + KHBH.L4 + KHBH.L5 + KHBH.L6) + (KHTN.L1 + KHTN.L2 + KHTN.L3 + KHTN.L4 + KHTN.L5 + KHTN.L6);
    if(tong == null)
    {
        tong = 0;
    }
}
@section HeadOfPage {
    <style type="text/css">
        .cell-center {
            text-align: center;
        }

        .tr-bold {
            font-weight: 700;
        }

        .ctl {
            position: relative;
            /*float: left;*/
            margin-right: 3px;
        }

            .ctl .error {
                position: absolute;
                background: #de2a2a;
                left: 0px;
                top: 28px;
                padding: 2px 5px;
                color: #fff;
                z-index: 999;
            }

                .ctl .error:before {
                    border-bottom: 7px solid #de2a2a;
                    border-left: 7px solid transparent;
                    border-right: 7px solid transparent;
                    left: 9px;
                    top: -6px;
                    content: "";
                    display: inline-block;
                    position: absolute;
                }

        .icon-add {
            margin-top: 0px !important;
        }

        .combojax {
            display: inline-block;
            position: initial !important;
            float: none !important;
        }

        .cssth {
            color: #707070;
        }
    </style>

}
@using (Html.BeginPageHeaderContainer(pageSetting))
{
    <select id="month" name="month">
        @for (int i = 1; i <= 12; i++)
        {
            <option value="@i" @(month == i.ToString() ? "Selected" : "")>Tháng @i</option>
        }

    </select>
    <select id="year" name="year">
        @for (int i = 2016; i <= (DateTime.Now.Year + 1); i++)
        {
            <option value="@i" @(year == i.ToString() ? "Selected" : "")>Năm @i</option>
        }

    </select>
    <select style="text-align-last:center;width:125px" class="item_countForBrand" id="countForBrand" name="countForBrand">
        @foreach (var item in origin)
        {
            <option @(FirstOrigin == item.Value ? "Selected" : "") value="@item.Value"> @item.Name </option>
        }
    </select>
    <select style="text-align-last:center;width:125px" class="item_NGUOILAP" id="NGUOILAP" name="NGUOILAP">
        <option value="0">-Người quản lý-</option>
        @foreach (var itemm in user2)
        {
            <option @(nguoilapid == itemm.Id.ToString() ? "Selected" : "") value="@itemm.Id"> @itemm.FullName </option>
        }
    </select>
}
<div class="table-responsive" id="BC_Target_KHBH_DSTN" style="margin-bottom:40px">

    <table class="table table-bordered">
        @if (listtarget != null)
        {
            <thead>
                <tr>
                    <th class="cssth">Còn thiếu</th>
                    <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(listtarget.Target - listtarget.DaDat)</td>
                    <th class="cssth">Target</th>
                    <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(listtarget.Target)</td>
                    <th class="cssth">DS KHBH</th>
                    <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(listtarget.DSKHBH)</td>
                    <th class="cssth">DS Thu Nợ</th>
                    <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(listtarget.DSTHUNO)</td>
                    <th class="cssth">Tổng KH</th>
                    <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(listtarget.DSKHBH + @listtarget.DSTHUNO)</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th class="cssth">Đã Đạt Theo KH</th>
                    <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(listtarget.DaDat)</td>
                    <th class="cssth">Target x 120%</th>
                    <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(listtarget.Target != 0 ? (listtarget.Target * 120) / 100 : listtarget.Target)</td>
                    <th class="cssth">Tỷ lệ % TC BH</th>
                    <td>@listtarget.TLTCBH</td>
                    <th class="cssth">Tỷ lệ % TC TN</th>
                    <td>@listtarget.TLTCTN</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Đã đạt ngoài KH</td>
                    <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(listtarget.DadatNgoaiKH - listtarget.DaDat)</td>
                    <td></td>
                    <td></td>
                    <th class="cssth">SL Cơ hội BH</th>
                    <td>@listtarget.SLCHBH</td>
                    <th class="cssth">SL cơ hội TN</th>
                    <td>@listtarget.SLCHTN</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Tổng đạt</td>
                    <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(listtarget.DadatNgoaiKH)</td>
                    <td></td>
                    <td></td>
                    <td>DS từ Tỷ lệ % TC BH</td>
                    <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2((decimal?)listtarget.TLTCBH*listtarget.DSKHBH/ 100)</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </tbody>
        }

    </table>
    <br />
    <br />
    <table class="table table-bordered">
        <thead>
            <tr>
                <th></th>
                <th>L1(-1)</th>
                <th>L2(10-20)</th>
                <th>L3(30-50)</th>
                <th>L4(60-70)</th>
                <th>L5(80-90)</th>
                <th>L6(100)</th>
            </tr>
        </thead>
        <tbody>

            <tr>
                <td>SỐ DEAL KHBH</td>
                <td>@KHBH.L1</td>
                <td>@KHBH.L2</td>
                <td>@KHBH.L3</td>
                <td>@KHBH.L4</td>
                <td>@KHBH.L5</td>
                <td>@KHBH.L6</td>
            </tr>


            <tr>
                <td>SỐ DEAL KHCDS</td>
                <td>@KHTN.L1</td>
                <td>@KHTN.L2</td>
                <td>@KHTN.L3</td>
                <td>@KHTN.L4</td>
                <td>@KHTN.L5</td>
                <td>@KHTN.L6</td>
            </tr>

            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td>Tổng deal</td>
                <td>@tong</td>
                <td>Tổng deal đang theo</td>
                <td>@((KHBH.L2 + KHBH.L3 + KHBH.L4 + KHBH.L5 + KHBH.L6) + (KHTN.L2 + KHTN.L3 + KHTN.L4 + KHTN.L5 + KHTN.L6))</td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td>L1/Tổng deal</td>
                <td>@(Math.Round((double)((KHBH.L1 + KHTN.L1) / (tong != 0 ? tong: 1) * 100)))  %</td>
                <td>L6/Tổng deal</td>
                <td>@(Math.Round((double)((KHBH.L6 + KHTN.L6) / (tong != 0 ? tong : 1)) * 100))  %</td>
            </tr>
        </tbody>
    </table>
</div>
@using (Html.BeginButtonContainer(pageSetting))
{
    <button class="btn btn-white btn-success btn-sm" type="button" value="Export" onclick="tableToExcel('BC_Target_KHBH_DSTN','TheoDoiKeHoachNhanVien(Target-DSKHBH-DSTN)')">
        <i class="ace-icon fa fa-file-excel-o"></i>
        Xuất excel
    </button>
}
@section Scripts {
    <script type="text/javascript">

            var tableToExcel = (function () {
                var uri = 'data:application/vnd.ms-excel;base64,'
                    , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
                    , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
                    , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }

                return function (table, name) {
                    if (!table.nodeType) table = document.getElementById(table)
                    var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
                    window.location.href = uri + base64(format(template, ctx))
                }
            })()
    </script>
}
