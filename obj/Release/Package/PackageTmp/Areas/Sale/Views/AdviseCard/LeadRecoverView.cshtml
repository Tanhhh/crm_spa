<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/js/bootstrap-datepicker.min.js"></script>

@using Erp.BackOffice.App_GlobalResources
@using Erp.BackOffice.Sale.Models
@using Erp.BackOffice.Sale.Controllers
@using Erp.BackOffice.Helpers
@using GridMvc.Html
@using Erp.BackOffice.Sale.Models
@using System.ComponentModel

@{
    ViewBag.Title = "Lead";
    bool isPopup = Request["IsPopup"] != null && Request["IsPopup"].ToString().ToLower() == "true" ? true : false;
    if (isPopup)
    {
        Layout = "~/Views/Shared/_PopupLayout.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/ACE_AdminLayout.cshtml";
    }

    var jsCallback = Request["jsCallback"] == null ? "" : Request["jsCallback"].ToString();

    Erp.BackOffice.Models.PageSetting pageSetting = new Erp.BackOffice.Models.PageSetting
    {
        ModuleName = "AdviseCard",
        ActionName = "LeadIndex",
        PageTitle = ViewBag.Title,
        DisplaySearchPanel = true,
        IsPopup = false,
        DisplayBackButton = false
    };

}
@*hau them*@
<style>

    .body-content {
        height: 85vh !important;
    }

    .loading {
        cursor: progress;
    }



    .modal-body input, .select2-container {
        margin-bottom: 10px !important;
    }

    .table-hover > tbody > tr:hover, .table > tbody > tr.active > td, .table > tbody > tr.active > th, .table > tbody > tr > td.active, .table > tbody > tr > th.active, .table > tfoot > tr.active > td, .table > tfoot > tr.active > th, .table > tfoot > tr > td.active, .table > tfoot > tr > th.active, .table > thead > tr.active > td, .table > thead > tr.active > th, .table > thead > tr > td.active, .table > thead > tr > th.active {
        background-color: #eaf4fd !important;
    }


    .btn-default2, #btnCloseAdd, #QuickEditLeadDisable, #btnLeadDelete {
        border: 2px solid #b7bbd2;
        background-color: #b7bbd2 !important;
        color: #fff !important;
        font-weight: bold;
        border-radius: 3px;
    }

        .btn-default2:hover, #btnCloseAdd:hover, #QuickEditLeadDisable:hover, #btnLeadDelete:hover {
            opacity: 0.8;
        }

    .btn-primary2, #saveLeadModal, #QuickEditLead, #QuickEditLeadEnable {
        border: 2px solid #3F51B5;
        background-color: #3f51b5 !important;
        color: #ffffff !important;
        font-weight: bold;
        border-radius: 3px;
        padding: 5px 20px !important;
    }

    #btnLeadOpenPpAssign {
        /*   border: 2px solid #48D1CC;
        background-color: #20B2AA !important;*/
        /*    color: #3f51b5 !important;
        font-weight: bold;*/
        border-radius: 3px;
        padding: 5px 12px !important;
    }

    #btnLeadexitoption {
        border: 2px solid #FF6347;
        background-color: #FF0000 !important;
        color: #ffffff !important;
        font-weight: bold;
        border-radius: 3px;
        padding: 5px 20px !important;
    }

        .btn-primary2:hover, #saveLeadModal:hover, #QuickEditLead:hover, #QuickEditLeadEnable:hover, #btnLeadOpenPpAssign:hover, #btnLeadexitoption:hover {
            opacity: 0.8;
        }

    #SubLeadLogsShow {
        margin-top: 10px !important;
    }

    .modal-body section {
        border: unset !important;
    }

    section h4 {
        margin-bottom: -10px !important;
        font-weight: bold;
    }

    #addNewContent {
        padding-left: 0px !important;
    }

    #LeadLogsShow > div:first-child {
        margin-top: 20px !important;
    }

    .modal-header, #StatusHeader, #select2parent {
        background: #7ea3c321
    }

    .modal-body section {
        margin-bottom: 20px;
        background: #fff;
        padding: 15px 30px !important;
    }

    #myDiv .btn-header-cmt:hover {
        background-color: #60c9f8 !important;
        color: #fff !important;
    }

    #submyDiv {
        height: 5px;
        background-color: #f1f1f1 !important;
        position: absolute;
        z-index: 1;
        margin-left: 10px;
        margin-top: -10px;
    }

    .btn.active.focus, .btn.active:focus, .btn.focus, .btn:active.focus, .btn:active:focus, .btn:focus {
        outline: unset !important;
    }

    #myDiv {
        background: #fff;
        padding: 10px 10px 0 0;
    }

        #myDiv .active {
            border-bottom: 4px solid blue !important;
            background-color: #fff !important;
            color: blue !important;
            font-weight: bold;
            z-index: 2;
        }

    .btn-header-cmt {
        border-top: unset;
        border-left: unset;
        border-right: unset;
        margin: 0 !important;
        background-color: #fff !important;
        border-color: #fff !important;
        color: #000 !important;
        width: 10%;
    }

    .bg-info {
        background-color: #03a9f4a1;
    }

    #StatusHeader label:hover {
        background-color: #64da69cc !important;
        transform-origin: left;
        width: fit-content !important;
        clip-path: polygon(0% 0%, 100% 0%, 100% 50%, 100% 100%, 0 100%) !important;
        box-shadow: inset 200px 0em 0 0 #64da6954;
        font-weight: bold;
        border-radius: 5px;
    }

    #StatusHeader label {
        width: 5% !important;
        /* background-color: #03a9f4a1 !important;*/
        padding: 5px;
        transition: all 1s;
        text-transform: uppercase;
        border-radius: 5px;
        margin-left: -4px;
    }

    .table > tbody > tr > td, .table > tbody > tr > th, .table > tfoot > tr > td, .table > tfoot > tr > th, .table > thead > tr > td, .table > thead > tr > th {
        border-right: unset;
    }

    #muc-luc li:hover {
        background: #12e4ff;
    }

    #muc-luc ul {
        text-transform: uppercase;
        white-space: nowrap;
        overflow: hidden;
        width: 100%;
        margin: 0 !important;
    }

    #muc-luc li {
        padding: 5px 0;
        border-bottom: 1px solid #0000002b;
        margin: 0 !important;
        padding-left: 10px;
    }

    #searchInputForm span {
        height: 86% !important;
        background: #12e4ff;
        display: inline-table;
        border-radius: 3px;
        margin: 0 2px;
        padding-left: 5px;
    }

    #searchInputForm button {
        height: 100%
    }

    #searchInputForm {
        display: flex;
        align-items: center;
    }

    #SearchLeadForm {
        box-shadow: 0px 0px 15px #000;
    }

    .width-34 {
        width: 34%;
    }

    section label {
        color: #3F51B5;
    }

    .custom-class {
        color: #3f4d9d;
        vertical-align: middle;
    }

    .modal-open .modal {
        overflow-y: unset;
    }

    #muc-luc {
        border-right: 1px solid #337ab7;
        width: 35%;
    }

    .select2-container {
        width: 100% !important;
    }

    .content {
        width: 80%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    #searchPanelContent {
        display: flex;
        height: 540px;
        overflow: hidden;
        padding-right: 0px;
        padding-left: 0px;
    }

    #btnAdd {
        position: sticky;
        bottom: 0% !important;
    }

    .select2-container .select2-selection--multiple .select2-selection__rendered {
        display: block !important;
    }

    @@media (max-width : 1480px) {
        #modal-search {
            left: 75px !important;
            width: 50% !important;
        }

        .content {
            width: 90%;
        }
    }

    @@media (max-width : 1440px) {
        #modal-search {
            left: 18px !important;
            width: 44% !important;
        }
    }


    @@media (max-width : 1440px) {
        #modal-search {
            left: 120px !important;
            width: 44% !important;
        }

        .content {
            width: 65%;
        }

        .width-34 {
            width: 80%;
            margin-bottom: 10px;
        }
    }

    #searchPanelContent input {
        border: 1px solid;
        margin-right: 10px;
    }

    .modal-backdrop.in {
        display: none;
    }

    .table > thead:first-child > tr:first-child > th {
        background: #fff;
        color: #152cad !important;
    }

    .btn-success, .btn-success.focus, .btn-success:focus {
        background-color: rgba(255, 255, 255, 0.2) !important;
        border-color: #fff !important;
        border: 0px solid !important;
    }

    .btn-search, .btn-setting {
        display: inline-block;
        float: left;
        width: 33px;
        height: 24px;
        cursor: pointer;
        background: url('/assets/img/btn_title_right.gif') no-repeat;
        margin: 0px;
        margin-left: -33px;
    }

    .btn-search {
        background-position: -1px -24px;
    }

        .btn-search:hover {
            background-position: -35px -24px;
        }

    .btn-setting:hover {
        background-position: -34px 0px;
    }

    .tag-container {
        display: inline-block;
        /*            border: 1px solid #ccc;*/
        padding: 5px;
    }

        .tag-container span {
            background-color: #f0f0f0;
            padding: 3px 5px;
            margin-right: 5px;
            border-radius: 3px;
        }

    #btnSearchLead, #btnCloseSearch, #saveLeadModal, #btnCloseAdd {
        margin: 0;
        border-radius: 3px;
        padding: 3px 20px;
    }

    #saveLeadModal {
        margin-left: 20px;
        padding: 3px 25px !important;
    }

    #searchPanelContent span {
        background-color: unset;
        /* width:200px;*/
    }

    .select2-results__option[aria-selected] {
        background: #fff;
    }

    /*thanh*/
    .nav-item {
        align-self: center !important;
    }

        .nav-item .active {
            background-color: rgba(255, 255, 255, 0.2) !important;
        }

    .nav-link {
        padding: 5px 15px !important;
        color: white !important;
    }

        .nav-item:hover,
        .nav-link:hover {
            background-color: #629B58 !important;
            border-radius: 4px;
        }


    #empty-trash-button:hover {
        background-color: red;
        color: white;
    }

    #empty-trash-button {
        padding: 10px 20px;
        /* background-color: #f00; */
        color: #f00;
        border: 1px solid red;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
    }

    #select-box-recover {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        width: 200px;
        background-color: #f9f9f9;
        color: #333;
    }

        #select-box-recover:hover {
            border-color: #666;
        }
</style>
@*end*@


<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css" integrity="sha512-3pIirOrwegjM6erE5gPSwkUzO+3cTjpnV9lexlNZqvupR64iZBnOOTiiLPb9M36zpMScbmUNIcHUqKD47M719g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">

<!-- jQuery -->

<!-- DataTables JavaScript -->
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
<nav class="navbar navbar-default">
    <div style="display: flex !important; align-items: center;" class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div style="width: 15%; margin-left: 25px; margin-right:auto" class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">Thùng rác</a>
        </div>

        <div style="align-items: center;">
            <select id="select-box-recover">
                <option value="0" selected>Lead</option>
                <option value="1">Khách hàng</option>
            </select>
        </div>
        <div class="trash-bin" style=" align-items: center;">
            <button id="empty-trash-button">Làm trống thùng rác</button>
        </div>

    </div><!-- /.container-fluid -->
</nav>
<div id="LeadTbl" style="min-height: 85vh;">

</div>

<!-- Modal content -->
<!-- Z-Index để ẩn NavBar -->
<div style="z-index: 1030; height: 110%; padding-left: 0px;" id="addNewContent" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">

</div>
<!-- Modal content -->
<div style="top: 83px;" class="modal fade bs-searchPanel-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
    <div id="modal-search" class="modal-dialog modal-sm" style="left: 50px; right: 0%; position: absolute; width: 50%; top: -31px; " role="document">
        <div class="modal-content">
            <!-- Modal header -->
            <div style="display:none" class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">Tìm kiếm</h4>
            </div>
            <form id="SearchLeadForm" action="/AdviseCard/SearchLeadRecover" method="post">

                <!-- Modal body -->
                <div id="searchPanelContent" class="modal-body"></div>
                <!-- Modal footer -->

                <div style="position: sticky; bottom: 20px;" class="modal-footer">

                    <button id="btnCloseSearch" type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                    <button id="btnSearchLead" type="button" class="btn btn-primary">Tìm kiếm</button>
                </div>
            </form>

        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script>

    $('#btnSearchLead').click(function () {
        let cookiepg = getCookieLeadIndex('ListOrKanbanId');
        if (cookiepg == 0) {
            let cookie = getCookieLeadIndex('pageSize')
            SearchLeadFunc(1, cookie)
        } else {
            callKanban(0);
        }

    })

    function SearchLeadFunc(pageNumber, pageSize) {
        ShowLoading();
        var formData = new FormData($('#SearchLeadForm')[0]);
        formData.append('pageNumber', pageNumber);
        formData.append('pageSize', pageSize);
        $.ajax({
            type: "POST",
            url: $('#SearchLeadForm')[0].action,
            data: formData,
            processData: false,
            contentType: false,
            /*  async: false,*/
            dataType: "html",
            success: function (data, textStatus, jqXHR) {
                $('#LeadTbl').html(data)
                /*  $('.js-example-basic-single').select2();*/
                $("#btnCloseSearch").trigger("click")
            },
            error: function (data, textStatus, jqXHR) {
                toastr.warning('Xảy ra lỗi!')
            },
            complete: function () {
                debugger
                HideLoading();
            }
        })
    }

    function SearchCustomer() {
        ShowLoading();
        $.ajax({
            type: "GET",
            url: '/AdviseCard/SearchCustomerRecover',
            processData: false,
            contentType: false,
            /*  async: false,*/
            dataType: "html",
            success: function (data, textStatus, jqXHR) {
                $('#LeadTbl').html(data)
                /*  $('.js-example-basic-single').select2();*/
                $("#btnCloseSearch").trigger("click");
            },
            error: function (data, textStatus, jqXHR) {
                toastr.warning('Xảy ra lỗi!')
            },
            complete: function () {
                debugger
                HideLoading();
            }
        })
    }
    function getCookieLeadIndex(name) {
        debugger
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        else {
            if (name == "pageSize") {
                return 15;
            } else
                return 0;
        }
    }
    function setCookie(name, value, days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function fnRecoverLead(arr) {
        $.ajax({
            url: "/AdviseCard/RecoverLead",
            method: "post",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(arr),
            dataType: "json",
            success: function (data) {
                if (data > 0) {
                    toastr.success('Phục hồi thành công!')
                    let cookie = getCookieLeadIndex('pageSize')
                    SearchLeadFunc(1, cookie)
                } else {
                    toastr.warning('Phục hồi thất bại!')
                }
            }
        })
    }
    function fnDeleteAllLeadInRecover(arr) {
        $.ajax({
            url: "/AdviseCard/DeleteAllLeadInRecover",
            method: "post",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(arr),
            dataType: "json",
            success: function (data) {
                if (data > 0) {
                    toastr.success('Xóa tất cả thành công!')
                    let cookie = getCookieLeadIndex('pageSize')
                    SearchLeadFunc(1, cookie)
                } else {
                    toastr.warning('Xóa tất cả thất bại!')
                }
            }
        })
    }
    function handleSelectBoxChange() {
        let selectBox = document.getElementById("select-box-recover");
        let options = selectBox.options;
        for (let i = 0; i < options.length; i++) {
            if (options[i].selected && options[i].value === "0") {
                // Nếu tùy chọn "Lead" được chọn, gán cookiepg bằng 0
                let cookie = getCookieLeadIndex('pageSize');
                SearchLeadFunc(1, cookie);
                break; // Kết thúc vòng lặp sau khi tìm thấy tùy chọn được chọn
            }
            else {
                SearchCustomer();
            }
        }
    }
    $(document).ready(function () {
        debugger;
        $('#muc-luc ul li').click(function () {
            window.location = $('a', this).attr('href');
        });

        handleSelectBoxChange();

        $(document).on('click', '#btnLeadRecover', function () {
            debugger
            Swal.fire({
                title: 'Bạn có chắc chắn muốn phục hồi những Lead này không?',
                icon: 'check',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Phục hồi',
                cancelButtonText: 'Không'
            }).then((result) => {
                if (result.isConfirmed) {
                    var ele = $('#LeadTblR').find('.checkbox.child:checked')
                    let arr = []
                    $.each(ele, function (idx, item) {
                        arr.push(parseInt($(this).parent().prev().text()))
                    })
                    fnRecoverLead(arr);
                } else {

                }
            })
        })

        $("#select-box-recover").change(function () {
            // Lấy giá trị của tùy chọn được chọn
            let selectedValue = $(this).val();

            // Gán giá trị vào biến cookiepg
            let cookiepg = parseInt(selectedValue);

            // Kiểm tra giá trị của cookiepg và thực hiện các hành động tương ứng
            if (cookiepg === 0) {
                let cookie = getCookieLeadIndex('pageSize');
                SearchLeadFunc(1, cookie);
            } else {
                SearchCustomer();
            }
        });

    });
    $(document).on('click', '#empty-trash-button', function () {
        var chkallCheckbox = document.querySelector('.checkbox.chkall');
        if (chkallCheckbox) {
            chkallCheckbox.checked = true;
        }
        var ele = $('#LeadTblR').find('.checkbox.child')
        let chkall = $('.checkbox.chkall').prop('checked');
        $.each(ele, function (idx, item) {
            if (chkall == true) {
                $(item).prop('checked', true)
            } else {
                $(item).prop('checked', false)
            }
        })
        Swal.fire({
            title: 'Bạn có chắc chắn muốn phục hồi những Lead này không?',
            icon: 'check',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Xóa tất cả',
            cancelButtonText: 'Không'
        }).then((result) => {
            if (result.isConfirmed) {
                var ele = $('#LeadTblR').find('.checkbox.child:checked')
                let arr = []
                $.each(ele, function (idx, item) {
                    arr.push(parseInt($(this).parent().prev().text()))
                })
                fnDeleteAllLeadInRecover(arr);
            } else {

            }
        })
    })
</script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="~/Scripts/jquery.signalR-2.4.3.min.js" type="text/javascript"></script>
<script src="~/signalr/hubs"></script>
<script type="text/javascript">
    var hub = $.connection.erpHub;
    hub.client.f5LeadLogs = function (id) {
        debugger
        if (id == $('#IdLead').val()) {
            $.ajax({
                url: '/AdviseCard/LeadLogsView?id=' + id,
                method: "get",
                dataType: "html",
                success: function (data) {
                    $('#LeadLogsShow').html(data)
                }
            })

        }
    };
    hub.client.LeadLogsMeeting = function (LeadId) {
        debugger
        if (LeadId == $('#IdLead').val()) {
            $.ajax({
                url: '/AdviseCard/LeadLogsMeetingView?LeadId=' + LeadId,
                method: "get",
                dataType: "html",
                success: function (data) {
                    $('#LeadLogsMeetingShow').html(data);
                }
            })

        }
    };
    $.connection.hub.start();
    $.connection.hub.disconnected(function () {
        debugger
        console.log('Connection lost, attempting to reconnect.');
        setTimeout(function () {
            debugger
            $.connection.hub.start();
        }, 5000); // Retry connection after 5 seconds
    });
</script>
<script>
    function isValidEmail(email) {
        if (email === "") {
            return true;
        }
        var emailRegex = /\S+@@\S+\.\S+/;
        return emailRegex.test(email);
    }

    function isValidMobile(mobile) {
        if (mobile === "") {
            return true;
        }
        var mobileRegex = /^\+?\d+$/;
        return mobileRegex.test(mobile);
    }
</script>


<script>
    //thanh
    var urlParams = new URLSearchParams(window.location.search);
    var detailLeadId = urlParams.get('detailLeadId');
    if (detailLeadId) {
        var url = window.location.href;
        url = url.split('?')[0];
        history.replaceState({}, '', url);
        DetailLead(detailLeadId);
    }
</script>
