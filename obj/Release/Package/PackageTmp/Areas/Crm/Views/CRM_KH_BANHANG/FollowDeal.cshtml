@using Erp.BackOffice.Crm.Models
@using Erp.BackOffice.Areas.Cms.Models
@using Erp.BackOffice.App_GlobalResources
@using Erp.BackOffice.Sale.Models
@using Erp.BackOffice.Helpers

@{
    ViewBag.Title = "Theo dõi deal chi nhánh";
    bool isPopup = Request["IsPopup"] != null && Request["IsPopup"].ToString().ToLower() == "true" ? true : false;
    if (isPopup)
    {
        Layout = "~/Views/Shared/_PopupLayout.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/ACE_AdminLayout.cshtml";
    }
    Erp.BackOffice.Models.PageSetting pageSetting = new Erp.BackOffice.Models.PageSetting
    {
        ModuleName = "CRM_KH_BANHANG",
        ActionName = "FollowDeal",
        PageTitle = ViewBag.Title,
        DisplaySearchPanel = true,
        IsPopup = false,
        DisplayBackButton = false
    };

    string Month = Request["month"] != null ? Request["month"] : DateTime.Now.Month.ToString();
    string Year = Request["year"] != null ? Request["year"] : DateTime.Now.Year.ToString();
    int n = 0;
    List<FollowDealViewModel> model = (List<FollowDealViewModel>)ViewBag.model;
    List<FollowDealViewModel> model2 = (List<FollowDealViewModel>)ViewBag.model2;
    List<FollowDealViewModel> model3 = (List<FollowDealViewModel>)ViewBag.model3;
    List<FollowDealViewModel> model4 = (List<FollowDealViewModel>)ViewBag.model4;
    string ManagerStaffid = Request["ManagerStaffId"] != null ? Request["ManagerStaffId"] : "0";

}



<link href="@Url.Content("~/assets/css/Gridmvc.css")" rel="stylesheet" type="text/css" />
<script src="@Url.Content("~/Scripts/gridmvc.min.js")" type="text/javascript"></script>

@if (ViewBag.SuccessMessage != null && ViewBag.SuccessMessage != "")
{
    <div class="alert alert-block alert-success">
        <button class="close" data-dismiss="alert" type="button">
            <i class="ace-icon fa fa-times"></i>
        </button>
        <i class="ace-icon fa fa-check green"></i>
        @ViewBag.SuccessMessage
    </div>
}

@if (ViewBag.FailedMessage != null && ViewBag.FailedMessage != "")
{
    <div class="alert alert-block alert-danger">
        <button class="close" data-dismiss="alert" type="button">
            <i class="ace-icon fa fa-times"></i>
        </button>
        <i class="ace-icon fa fa-warning red"></i>
        @ViewBag.FailedMessage
    </div>
}


@using (Html.BeginPageHeaderContainer(pageSetting))
{
    <input type="hidden" value="@Request["IsPopup"]" name="IsPopup" />
        <input type="hidden" value="@Request["jsCallback"]" name="jsCallback" />
        <p>
            <select class="chzn-select" style="width:250px; float:left" id="ManagerStaffId" name="ManagerStaffId">
                <option value="">- Nhân viên QL -</option>
                @foreach (var item in SelectListHelper.GetSelectList_FullUserNameKD(null, null))
                {
                    <option @(ManagerStaffid == item.Value ? "Selected" : "") value="@item.Value">@item.Text</option>
                }
            </select>

              <label>Tháng</label>
            <select id="month" name="month">
                @for (int i = 1; i <= 12; i++)
                {
                    <option @(Month == i.ToString() ? "Selected" : "") value="@i">@i</option>
                }
            </select>
            <label>Năm</label>
            <select id="year" name="year">
                @for (int i = 2016; i <= (DateTime.Now.Year + 1) + 1; i++)
                {
                    <option @(Year == i.ToString() ? "Selected" : "") value="@i">@i</option>
                }
            </select>
            
        </p>

    
}

<div class="table-responsive" id="BC_ChiSoCacTuanTrongThang" style="margin-bottom:40px">
    <table id="cTable" class="table table-bordered">
        <thead>
            <tr class="">
                <th class="" colspan="11" style="text-align:center"><h4>BÁO CÁO DEAl CÁC TUẦN TRONG THÁNG @Month</h4></th>
            </tr>
            <tr>
                <th style="width:100px;text-align:center"></th>
                <th style="min-width:100px;text-align:center"></th>
                <th style="min-width:100px;text-align:center"></th>
                
                <th style="min-width:100px;text-align:center">ORLANE PARIS</th>
                <th style="min-width:100px;text-align:center">ANNAYAKE</th>
                <th style="text-align:center">LEONOR GREYL</th>
               

            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < 4; i++)
            {
                n++;
                if (n == 1)
                {
                    

                     <tr>

                         <th rowspan="4">Tuần 1</th>


                         <th rowspan="2">Doanh số</th>


                         <th>-1</th>

                         @foreach(var item in model)
                         {
                             <td>@item.PhanTramDSTB %</td>
                         }

                     </tr>

                     <tr>


                         <th>100</th>


                         @foreach (var item in model)
                         {
                            <td>@item.PhanTramDSTC %</td>
                         }



                     </tr>

                     <tr>


                         <th rowspan="2">Deal</th>


                         <th>-1</th>


                         @foreach (var item in model)
                         {
                            <td>@item.PhanTramDealTB %</td>
                         }


                     </tr>

                     <tr>


                         <th>100</th>


                         @foreach (var item in model)
                         {
                            <td>@item.PhanTramDealTC %</td>
                         }


                     </tr>
                }
                if (n == 2)
                {
                    <tr>

                        <th rowspan="4">Tuần 2</th>


                        <th rowspan="2">Doanh số</th>


                        <th>-1</th>

                        @foreach (var item in model2)
                        {
                            <td>@item.PhanTramDSTB %</td>
                        }

                    </tr>

                    <tr>


                        <th>100</th>


                        @foreach (var item in model2)
                        {
                            <td>@item.PhanTramDSTC %</td>
                        }



                    </tr>

                    <tr>


                        <th rowspan="2">Deal</th>


                        <th>-1</th>


                        @foreach (var item in model2)
                        {
                            <td>@item.PhanTramDealTB %</td>
                        }


                    </tr>

                    <tr>


                        <th>100</th>


                        @foreach (var item in model2)
                        {
                            <td>@item.PhanTramDealTC %</td>
                        }


                    </tr>
                }
                if (n == 3)
                {
                    <tr>

                        <th rowspan="4">Tuần 3</th>


                        <th rowspan="2">Doanh số</th>


                        <th>-1</th>

                        @foreach (var item in model3)
                        {
                            <td>@item.PhanTramDSTB %</td>
                        }

                    </tr>

                    <tr>


                        <th>100</th>


                        @foreach (var item in model3)
                        {
                            <td>@item.PhanTramDSTC %</td>
                        }



                    </tr>

                    <tr>


                        <th rowspan="2">Deal</th>


                        <th>-1</th>


                        @foreach (var item in model3)
                        {
                            <td>@item.PhanTramDealTB %</td>
                        }


                    </tr>

                    <tr>


                        <th>100</th>


                        @foreach (var item in model3)
                        {
                            <td>@item.PhanTramDealTC %</td>
                        }


                    </tr>
                }
                if (n == 4)
                {
                    <tr>

                        <th rowspan="4">Tuần 4</th>


                        <th rowspan="2">Doanh số</th>


                        <th>-1</th>

                        @foreach (var item in model4)
                        {
                            <td>@item.PhanTramDSTB %</td>
                        }

                    </tr>

                    <tr>


                        <th>100</th>


                        @foreach (var item in model4)
                        {
                            <td>@item.PhanTramDSTC %</td>
                        }



                    </tr>

                    <tr>


                        <th rowspan="2">Deal</th>


                        <th>-1</th>


                        @foreach (var item in model4)
                        {
                            <td>@item.PhanTramDealTB %</td>
                        }


                    </tr>

                    <tr>


                        <th>100</th>


                        @foreach (var item in model4)
                        {
                            <td>@item.PhanTramDealTC %</td>
                        }


                    </tr>
                }

            }
        </tbody>
    </table>
</div>


@using (Html.BeginButtonContainer(pageSetting))
{
    <button class="btn btn-white btn-success btn-sm" type="button" value="Export" onclick="tableToExcel('BC_ChiSoCacTuanTrongThang', 'TheoDoiKeHoachNhanVien')">
        <i class="ace-icon fa fa-file-excel-o"></i>
        Xuất excel
    </button>
}
@section Scripts {
    <script type="text/javascript">

            var tableToExcel = (function () {
                var uri = 'data:application/vnd.ms-excel;base64,'
                    , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
                    , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
                    , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }

                return function (table, name) {
                    if (!table.nodeType) table = document.getElementById(table)
                    var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
                    window.location.href = uri + base64(format(template, ctx))
                }
            })()
    </script>
}