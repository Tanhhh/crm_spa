@model Erp.BackOffice.Crm.Models.CRM_KH_BANHANGViewModel
@using Erp.BackOffice.Account.Models
@using Erp.BackOffice.Crm.Models
@using Erp.BackOffice.Areas.Cms.Models
@using Erp.BackOffice.App_GlobalResources
@using Erp.BackOffice.Sale.Models
@using Erp.BackOffice.Helpers
@using GridMvc.Html

@{
    IEnumerable<ProductInvoiceViewModel> ProductInvoice = (IEnumerable<ProductInvoiceViewModel>)ViewBag.ProductInvoice;
    IEnumerable<CRM_KH_BANHANG_CTIETViewModel> vwCRM_KH_BANHANGCT = (IEnumerable<CRM_KH_BANHANG_CTIETViewModel>)ViewBag.vwCRM_KH_BANHANG;
    string Month = Request["Month"] != null ? Request["Month"] : new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day).ToString("MM/yyyy");
    string Year = Request["Year"] != null ? Request["Year"] : new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day).ToString("MM/yyyy");
    //string NGUOILAP_ID = Request["NGUOILAP_ID"] != null ? Request["NGUOILAP_ID"] : null;
    //IEnumerable<KH_TUONGTACViewModel> LICHSUTUONGTAC = (IEnumerable<KH_TUONGTACViewModel>)ViewBag.LICHSUTUONGTAC;
    // IEnumerable<CRM_KH_BANHANGViewModel> BANHANG_CTIET_ProductInvoice = (IEnumerable<CRM_KH_BANHANGViewModel>)ViewBag.BANHANG_CTIET_ProductInvoice;
    decimal? sum = 0;

    //Model.CRM_KH_BANHANGList = vwCRM_KH_BANHANGCT.Where(x => x.KH_BANHANG_ID == @ViewBag.ID_ANNAYAKE).ToList();
}
<style>
    .div-num1{

    }
    .div-num5 {
        display:flex;
    }
    .div-num3 {
        display:flex;
    }
    .div-num4 {
        display:flex;
        text-align:right;
    }
    .div-num4 label{
        font-weight:bold;
        margin:5px 0 !important;
    }
    .edit-view .chosen-single, .edit-view input, .edit-view select {
        max-width: 600px !important;
    }
</style>


@Html.HiddenFor(model => model.KH_BANHANG_ID)
<div class="div-num4">
    <div class="div-num3">

        <div class="div-num2">
            <div class="div-num5">
                <div class="div-num1">
                    <label>Tháng/năm</label>
                    @Html.TextBox("month", Month + "/" + Year, new { autocomplete = "off", style = "width:200px", disabled = "true" })

                    <label style="padding-left:2px">
                        Taget(VNĐ)
                        <span class="help-button" data-rel="tooltip" data-placement="bottom" data-original-title="Nhập và nhấn Enter khi thay đổi" data-html="true">?</span>
                    </label>
                    @Html.TextBox("TARGET_BRAND", Request["TARGET_BRAND"], new { @class = "numberinput2", autocomplete = "off", placeholder = "TARGET", style = "width:200px" })

                </div>
                <div class="div-num1">
                    <label style="padding-left:51px">Người lập</label>
                    @Html.TextBox("NGUOILAP_ID", Request["NGUOILAP_ID"], new { @class = "hidden", autocomplete = "off", placeholder = "Người lập", style = "width:200px" })

                    @Html.TextBox("FullName", Request["FullName"], new { @class = "", disabled = "disabled", autocomplete = "off", placeholder = "Người lập", style = "width:200px" })

                    <label style="padding-left:10px">Kế hoạch đã lập</label>
                    <input type="text" name="TotalAmount" id="TotalAmount" style="width:200px" readonly="readonly" />
                </div>
            </div>
            <label style="padding-left:26px">
                Ghi chú
                <span class="help-button" data-rel="tooltip" data-placement="bottom" data-original-title="Nhập và nhấn Enter khi thay đổi" data-html="true">?</span>
                <input type="text" id="GHICHU" name="GHICHU" class="GHICHU" value="@Model.GHI_CHU" style="width:200px" />

            </label>
        </div>
        <div class="div-num2">
            <div class="div-num1">
                <label style="padding-left:80px">Nhãn hàng</label>
                <input type="text" value="@Model.CountForBrand" style="width:200px" readonly="readonly" />

                <label style="padding-left:10px">(%) Đạt theo kế hoạch</label>
                <input type="text" name="DATKH" id="DATKH" style="width:200px" readonly="readonly" />
            </div>
                <label style="padding-left:23px">(%) Đạt theo thực tế</label>
                <input type="text" name="DATTHUCTE" id="DATTHUCTE" style="width:200px" readonly="readonly" />
        </div>
    </div>
</div>


    @if (Model.KH_BANHANG_ID > 0)
    {
        <a class="btn btn-mini add" onclick="OpenPopup('@Url.Action("CreateKH", "CRM_KH_BANHANG",new { KH_BANHANG_ID=Model.KH_BANHANG_ID,Month=Month,Year=Year})','',0,0)">
            Thêm mới KH
        </a>

    }
    else
    {
        <a class="btn btn-mini add" onclick="OpenPopup('@Url.Action("CreateKH_BANHANG", "CRM_KH_BANHANG", new {CountForBrand=Model.CountForBrand, id=@ViewBag.NGUOILAP,month=Month,year=Year })','',0,0)">
            Lập kế hoạch mới
        </a>
    }

    <a id="btnKETHUAANAYAKE" class="btn btn-mini btn-primary">
        Kế thừa tháng trước
    </a>
</p>
<div id="listOrderDetail" class="table-responsive top-10 ">
    <table class="table table-bordered">
        <tbody>
            <tr>
                <td>Trạng thái deal:</td>
                <td style="background-color:#FDA7A7"><a class="trangthai">Từ chối</a></td>
                <td style="background-color:#AFEBEB"><a class="trangthai">Chưa duyệt</a></td>
                <td style="background-color:#FBFF9D"><a class="trangthai">Quản lý duyệt</a></td>
                <td style="background-color:#88FAB5"><a class="trangthai">Giám đốc duyệt</a></td>

            </tr>
        </tbody>
    </table>
    <table id="CTable" class="table table-bordered">
        <thead>
            <tr>
                <th rowspan="2" style="width:40px;text-align:center">STT</th>
                <th rowspan="2" style="text-align:center">
                    @Html.ActionLink("Tên khách hàng", "Create", new { id = @ViewBag.NGUOILAP_ID, month = Month, year = Year, sortOrder = ViewBag.NameSortParm })
                </th>
                <th rowspan="2" style="text-align:center">Mã KH</th>
                <th rowspan="2" style="text-align:center">Điện thoại </th>
                <th rowspan="2" style="width:100px;text-align:center">Thông tin lưu ý</th>
                <th rowspan="2" style="text-align:center">Tỷ lệ thành công(%)</th>
                <th rowspan="2" style="text-align:center">Ghi chú</th>
                <th rowspan="2" style="text-align:center">Đơn hàng PS</th>
                <th rowspan="2" style="text-align:center; width:130px">Đánh giá lại</th>
                <th rowspan="2" style="text-align:center">
                    @Html.ActionLink("Lịch sử tương tác", "Create", new { id = @ViewBag.NGUOILAP_ID, month = Month, year = Year, sortOrder = ViewBag.HistorySortParm })
                </th>
                <th rowspan="2" style="text-align:center">Đơn hàng dự kiến</th>
                <td></td>
            </tr>
        </thead>
        <tbody class="productInvoiceList">

            @if (Model.CRM_KH_BANHANGList.Count > 0)
            {
                int w = 0;

                for (int i = 0; i < Model.CRM_KH_BANHANGList.Count(); i++)
                {
                    var color = "blanchedalmond";
                    if (Model.CRM_KH_BANHANGList[i].IsApprove == 1)
                    {
                        color = "#FBFF9D";
                    }
                    else if (Model.CRM_KH_BANHANGList[i].IsApprove == 2)
                    {
                        color = "#88FAB5";
                    }

                    else if (Model.CRM_KH_BANHANGList[i].IsApprove == -1)
                    {
                        color = "#FDA7A7";
                    }
                    else
                    {
                        color = "#AFEBEB";
                    }
                    <tr style="background-color:@color" role="@(i + 1)" id="@(i + 1)">
                        <td class="text-center">
                            <span>@(w += 1)</span>
                            <input hidden class="IsApprove" value="@Model.CRM_KH_BANHANGList[i].IsApprove" />
                        </td>
                        <td>
                            <input class="id" type="hidden" id="CRM_KH_BANHANGList_@(i)__KH_BANHANG_CTIET_ID" name="CRM_KH_BANHANGList[@(i)].KH_BANHANG_CTIET_ID" value="@Model.CRM_KH_BANHANGList[i].KH_BANHANG_CTIET_ID" />
                            <input class="id" type="hidden" id="CRM_KH_BANHANGList_@(i)__KHACHHANG_ID" name="CRM_KH_BANHANGList[@(i)].KHACHHANG_ID" value="@Model.CRM_KH_BANHANGList[i].KHACHHANG_ID" />
                            <span>@Model.CRM_KH_BANHANGList[i].CompanyName</span>
                        </td>
                        <td>
                            <input class="name" type="hidden" id="CRM_KH_BANHANGList_@(i)__Code" name="CRM_KH_BANHANGList[@(i)].Code" value="@Model.CRM_KH_BANHANGList[i].Code" readonly="readonly" />
                            <span class="code" id="CRM_KH_BANHANGList_@(i)__Code" name="CRM_KH_BANHANGList[@(i)].Code" value="@Model.CRM_KH_BANHANGList[i].Code">@Model.CRM_KH_BANHANGList[i].Code</span>
                        </td>
                        <td>
                            <input class="phone" type="hidden" id="CRM_KH_BANHANGList_@(i)__Phone" name="CRM_KH_BANHANGList_[@(i)].Phone" value="@Model.CRM_KH_BANHANGList[i].Phone" readonly="readonly" />
                            <span>@Model.CRM_KH_BANHANGList[i].Phone</span>
                        </td>
                        <td>
                            @*<input class="THANG" type="text" id="@Model.NOIDUNG" name="@Model.NOIDUNG" value="@Model.NOIDUNG" />*@
                            <span>@Model.CRM_KH_BANHANGList[i].NOIDUNG</span>
                        </td>
                        <td>
                            @*<input style="width:50px" class="nr tylethanhcong" type="hidden" id="CRM_KH_BANHANGList_@(i)__TYLE_THANHCONG" name="CRM_KH_BANHANGList[@(i)].TYLE_THANHCONG" value="@(Model.CRM_KH_BANHANGList[i].TYLE_THANHCONG ==null ? 0 : Model.CRM_KH_BANHANGList[i].TYLE_THANHCONG)" readonly="readonly" />*@
                            <span hidden="hidden">@Model.CRM_KH_BANHANGList[i].TYLE_THANHCONG</span>
                            <input style="width:50px" class="nr tylethanhcong" type="text" id="CRM_KH_BANHANGList_@(i)__TYLE_THANHCONG" name="CRM_KH_BANHANGList[@(i)].TYLE_THANHCONG" value="@(Model.CRM_KH_BANHANGList[i].TYLE_THANHCONG == null ? 0 : Model.CRM_KH_BANHANGList[i].TYLE_THANHCONG)" readonly="readonly" />
                            @*<input style="width:50px" class="nr" type="text" id="CRM_KH_BANHANG_CTIETList@(i)__TYLE_THANHCONG" name="CRM_KH_BANHANG_CTIETList[@(i)].TYLE_THANHCONG " value="0" readonly="readonly" />*@
                            <input style="width:25px;color:white;border:none" class="btn-mini btn-CONG add" type="button" value="+" />
                            <input style="width:25px;color:white;border:none" class="btn-mini btn-TRU add" type="button" value="-" />
                        </td>
                        <td><span>@Model.CRM_KH_BANHANGList[i].GHI_CHU</span></td>


                        <td>

                            @foreach (var item in ProductInvoice.Where(x => x.CustomerId == Model.CRM_KH_BANHANGList[i].KHACHHANG_ID))
                            {
                                <a onclick="OpenPopup('@Url.Action("Detail", "ProductInvoice", new { area = "Sale", id = item.Id, IsPopup = true })','',0,0)">@CommonSatic.ToCurrencyStr(item.TotalAmount, null) <br /></a>
                            }

                        </td>
                        <td>
                            <input style="width:50px" class="nr_REVIEW tylethanhcongreview" type="text" id="CRM_KH_BANHANGList_@(i)__TYLE_THANHCONG_REVIEW" name="CRM_KH_BANHANGList[@(i)].TYLE_THANHCONG_REVIEW" value="@(Model.CRM_KH_BANHANGList[i].TYLE_THANHCONG_REVIEW == null ? 0 : Model.CRM_KH_BANHANGList[i].TYLE_THANHCONG_REVIEW)" readonly="readonly" />
                            <input style="width:25px;color:white;border:none" class="btn-mini btn-CONG-REVIEW add" type="button" value="+" />
                            <input style="width:25px;color:white;border:none" class="btn-mini btn-TRU-REVIEW add" type="button" value="-" />
                        </td>
                        <td>
                            <a onclick="OpenPopup('@Url.Action("LichSuTuongTac", "Plan", new { area = "Sale", NGUOILAP_ID = Model.NGUOILAP_ID, KHACHHANG_ID = Model.CRM_KH_BANHANGList[i].KHACHHANG_ID, IsPopup = true })', '', 0, 0)">Lịch tương tác tiếp theo</a>


                        </td>
                        <td>
                            <span> <a onclick="OpenPopup('@Url.Action("DetailProductInvoice", "CRM_KH_BANHANG", new { area = "Crm", Id = @Model.CRM_KH_BANHANGList[i].ProductInvoiceId })','',0,0)">@CommonSatic.ToCurrencyStr(@Model.CRM_KH_BANHANGList[i].TotalAmount, null)</a></span>

                            <a onclick="DeleteData(@Model.CRM_KH_BANHANGList[i].KH_BANHANG_CTIET_ID,@Model.CRM_KH_BANHANGList[i].ProductInvoiceId)" class="Delete" style="float:right">
                                <i class="ace-icon fa fa-trash red bigger-120" style="cursor:pointer"></i>
                            </a>
                            @if (Model.CRM_KH_BANHANGList[i].ProductInvoiceId == null)
                            {


                                <a class="glyphicon glyphicon-pencil" style="float:right;margin-right:20px" onclick="OpenPopup('@Url.Action("CreateProductInvoice", "CRM_KH_BANHANG", new { area = "Crm", CountForBrand = Model.CountForBrand, CustomerId = @Model.CRM_KH_BANHANGList[i].KHACHHANG_ID, CustomerName = @Model.CRM_KH_BANHANGList[i].CompanyName, KH_BANHANG_CTIET_ID = @Model.CRM_KH_BANHANGList[i].KH_BANHANG_CTIET_ID })','',0,0)"></a>
                            }
                        </td>
                        <td>
                            <a class="btn btn-mini btn-success" data-toggle="collapse" data-target="#popup_archive_@Model.CRM_KH_BANHANGList[i].KH_BANHANG_CTIET_ID" title="Chuyển Kế hoạch"><i class="ace-icon fa fa-refresh"></i></a>
                            <div id="popup_archive_@Model.CRM_KH_BANHANGList[i].KH_BANHANG_CTIET_ID" style="right: 0px !important; left: auto;top:auto;bottom:auto;height:200px" class="popover fade bottom">
                                <div class="arrow" style="left: 50%;"></div>
                                <h3 class="popover-title">Chuyển KHBH</h3>
                                <div class="popover-content">

                                    <input type="hidden" class="KHID" value="@Model.CRM_KH_BANHANGList[i].KH_BANHANG_CTIET_ID" />
                                    <div class="control-group form-group">
                                        <label class="control-label no-padding-right col-lg-5 col-md-4 col-sm-4" for="ReceiptViewModel_Amount">Tháng</label>
                                        <div class="control-value col-lg-7 col-md-8 col-sm-8">
                                            <input type="text" class="Thang">
                                        </div>
                                    </div>


                                    <div class="control-group form-group" style="border-top:0px">
                                        <label class="control-label no-padding-right col-lg-5 col-md-4 col-sm-4" for="AmountRemain">Năm</label>
                                        <div class="control-value col-lg-7 col-md-8 col-sm-8">
                                            <div class="clearfix">
                                                <input type="text" class="Nam" id="Nam">
                                            </div>
                                        </div>

                                    </div>


                                    <div>
                                        <p class="top-10">
                                            <button type="button" class="btn btn-mini btn-primary Success" data-toggle="collapse" value="Success" data-target="#popup_archive_@Model.CRM_KH_BANHANGList[i].KH_BANHANG_CTIET_ID">
                                                Đồng ý
                                            </button>
                                            <a class="btn btn-white btn-sm no-border close" data-toggle="collapse" data-target="#popup_archive_@Model.CRM_KH_BANHANGList[i].KH_BANHANG_CTIET_ID">Đóng</a>
                                        </p>
                                    </div>


                                </div>
                            </div>
                        </td>
                    </tr>
                }



            }
        </tbody>
        <thead>
            <tr hidden>
                <td colspan="7"></td>

                @if (ProductInvoice != null)
                {
                    <td id="DHPS">
                        @CommonSatic.ToCurrencyStr(ProductInvoice.Sum(x => x.TotalAmount), null)
                    </td>
                }
                <td></td>
                <td></td>
                @if (vwCRM_KH_BANHANGCT != null)
                {
                    <td id="Total">
                        @CommonSatic.ToCurrencyStr(vwCRM_KH_BANHANGCT.Sum(x => x.TotalAmount), null)
                    </td>
                }
            </tr>
        </thead>
    </table>
</div>

@for (int i = 0; i <= 100; i += 10)
{
    decimal? sum1 = 0;
    <label style="color:blue;padding-left:20px">
        @foreach (var item in Model.CRM_KH_BANHANGList)
        {
            if (item.TYLE_THANHCONG == i)
            {
                if (item.TotalAmount == null)
                {
                    item.TotalAmount = 0;
                }
                sum1 += item.TotalAmount;
            }
            sum = sum1;
        }
        @i%:( @(sum == null ? Convert.ToString(0) : CommonSatic.ToCurrencyStr(sum, null)) )
    </label>
}


<script type="text/javascript">

    $('.Success').click(function () {
        var $row = $(this).closest("td");
        var KHID = $row.find(".KHID").val();
        var Thang = $row.find(".Thang").val();
        var Nam = $row.find(".Nam").val();
        $.ajax({
            type: "POST",
            url: '@Url.Action("ChuyenKHBH", "CRM_KH_BANHANG")',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ KHID:KHID, Thang:Thang,Nam:Nam }),
            dataType: "json",
            success: function (result) {
                //alert(result);
                if(result ==1 ){
                   // $row.find(".close").click();
                    alert("Chuyển thành công !");

                }else{
                    alert("Chưa có kế hoạch cho tháng được chuyển !");
                }
            }
        });
    });


    $('#btnKETHUAANAYAKE').click(function () {
        if (confirm('Bạn có muốn kế thừa KHBH tháng trước không?')) {
            PostData123();
        }
        else {
            return false;
        }
    });
    //$('.Delete').click(function () {
    //    if (confirm('Bạn có muốn xóa item đã chọn ?')) {
    //        DeleteData($('.item_KH_BANHANG_CTIET_ID').text());
    //    }
    //    else {
    //        return false;
    //    }
    //}); , new { KH_BANHANG_ID = Model.KH_BANHANG_ID}
    function PostData123() {
        $.ajax({
            type: "POST",
            url: '@Url.Action("KETHUA", "CRM_KH_BANHANG")',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ model: {KH_BANHANG_ID: '@Model.KH_BANHANG_ID', CountForBrand: '@Model.CountForBrand', NGUOILAP_ID:@Model.NGUOILAP_ID, month:@Month+"/"+@Year} }),
            dataType: "json",
            success: function (result) {
                //alert(result);
                window.locationre = result.url;
            }
        });
        location.reload();
    }

    function DeleteData(KH_BANHANG_CTIET_ID, ProductInvoiceId) {
        if (confirm('Bạn có muốn xóa item đã chọn ?')) {

            $.ajax({
                type: "POST",
                url: '@Url.Action("Delete", "CRM_KH_BANHANG")',
                data: JSON.stringify({ model: { KH_BANHANG_CTIET_ID: KH_BANHANG_CTIET_ID, ProductInvoiceId: ProductInvoiceId} }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (result) {
                    //alert(result);
                    window.locationre = result.url;
                }
            });
            location.reload();
        }
        else {
            return false;
        }

    }
    $(document).ready(function () {
        //debugger
        $('[data-rel=tooltip]').tooltip({ container: 'body' });
        $('#month').val("@Month/@Year");
        var ANNAYAKE = 0;
        var DAT = 0;
        var DHPS = $('#DHPS').text();
        var Total = $('#Total').text();

        ANNAYAKE = $('#TARGET_BRAND').val();

        $('#TotalAmount').val($.trim(Total));
        var q = ((parseFloat(removeComma(Total) / parseFloat(removeComma(ANNAYAKE))) * 100)).toFixed(1);
        var DonhangPS = (parseFloat(removeComma(DHPS) / parseFloat(ANNAYAKE)) * 100).toFixed(1);
        //alert(DonhangPS);
        //(isNaN($('#DAT').val(numeral(q).format('0,0'))) ? 0 : $('#DAT').val(numeral(q).format('0,0')));
        $('#DATKH').val(q)
        $('#DATTHUCTE').val(DonhangPS)
        //$('#DAT').val(numeral(q).format('0,0'));
        if (isNaN(($('#DAT').val()))) {
            $('#DAT').val(0);
        } else {
            $('#DAT').val(numeral(q).format('0,0.0'));
        }
        if ($('#DAT').val() > 100) {
            $('#DAT').val(100);
        }
        if (isNaN(($('#DATTHUCTE').val()))) {
            $('#DATTHUCTE').val(0);
        } else {
            $('#DATTHUCTE').val(numeral(DonhangPS).format('0,0.0'));
        }

        var value = $("#txtSearch").val().trim();
        if (value != '') {
            $("table tbody tr").hide();
        } else {
            $("table tbody tr").show();
        }
        $('table tbody tr td:contains("' + value + '")').parent('tr').show();

        //if (removeComma($('#DATTHUCTE').val()) > 100) {
        //    $('#DATTHUCTE').val(100);
        //}
    });
    //$('#listOrderDetail').on('click', '.btn-delete-item', function () {
    //    $(this).closest('tr').remove();
    //    $('.productInvoiceList tr').each(function (index, tr) {
    //        $(tr).attr('role', index);
    //        $(tr).find('td:first-child').text(index);
    //        $(tr).find('.id').attr('name', 'CRM_KH_BANHANG_CTIETList[' + index + '].Id').attr('id', 'CRM_KH_BANHANG_CTIETList_' + index + '__Id');
    //        $(tr).find('.code').attr('name', 'CRM_KH_BANHANG_CTIETList[' + index + '].Code').attr('id', 'CRM_KH_BANHANG_CTIETList_' + index + '__Code');
    //        $(tr).find('.phone').attr('name', 'CRM_KH_BANHANG_CTIETList[' + index + '].Phone').attr('id', 'CRM_KH_BANHANG_CTIETList_' + index + '__Phone');
    //        $(tr).find('.item_price').attr('name', 'InvoiceList[' + index + '].Price').attr('id', 'InvoiceList_' + index + '__Price');
    //        $(tr).find('.item_locode').attr('name', 'InvoiceList[' + index + '].LoCode').attr('id', 'InvoiceList_' + index + '__LoCode');
    //    });
    //});
    $('#listOrderDetail').on('click', '.btn-CONG', function () {
        var $row = $(this).closest("tr");    // Find the row
        var $text = $row.find(".nr").val(); // Find the text
        var w = parseFloat($text);
        if (w < 0) {
            w = -1;
        }
        if (w > 0) {
            w += 10;
        } if (w == 0) {
            w += 10;
        }
        if (w == -1) {
            w = 0;
        }
        if (w > 100) {
            w = 100;
            alert('Tỷ lệ thành công không được quá 100%');
        }
        $row.find(".nr").val(w);

        var kh_id = $row.find("td:eq(1) input:nth-child(1)").val();
        var khach_id = $row.find("td:eq(1) input:nth-child(2)").val();
        var tyle = $row.find("td:eq(5) input").val();
        var tylerw = $row.find("td:eq(8) input").val();

        UpdateTaget(kh_id,khach_id,tyle,tylerw);
    });
    $('#listOrderDetail').on('click', '.btn-TRU', function () {
        var $row = $(this).closest("tr");    // Find the row
        var $text = $row.find(".nr").val(); // Find the text
        var w = parseFloat($text);
        if (w == 0) {
            w = -1;
        }
        if (w < 0) {
            w = -1;
        } if (w == -1) {
            w = -1;
        } if (w > 0) {
            w += -10;
        }
        $row.find(".nr").val(w);

        var kh_id = $row.find("td:eq(1) input:nth-child(1)").val();
        var khach_id = $row.find("td:eq(1) input:nth-child(2)").val();
        var tyle = $row.find("td:eq(5) input").val();
        var tylerw = $row.find("td:eq(8) input").val();

        UpdateTaget(kh_id,khach_id,tyle,tylerw);
    });
    $('#listOrderDetail').on('click', '.btn-CONG-REVIEW', function () {
        var $row = $(this).closest("tr");    // Find the row
        var $text = $row.find(".nr_REVIEW").val(); // Find the text
        var w = parseFloat($text);
        if (w < 0) {
            w = -1;
        }
        if (w > 0) {
            w += 10;
        } if (w == 0) {
            w += 10;
        }
        if (w == -1) {
            w = 0;
        }
        if (w > 200) {
            w = 200;
            alert('Tỷ lệ thành công không được quá 200%');
        }
        $row.find(".nr_REVIEW").val(w);

        var kh_id = $row.find("td:eq(1) input:nth-child(1)").val();
        var khach_id = $row.find("td:eq(1) input:nth-child(2)").val();
        var tyle = $row.find("td:eq(5) input").val();
        var tylerw = $row.find("td:eq(8) input").val();

        UpdateTaget(kh_id,khach_id,tyle,tylerw);
    });
    $('#listOrderDetail').on('click', '.btn-TRU-REVIEW', function () {
        var $row = $(this).closest("tr");    // Find the row
        var $text = $row.find(".nr_REVIEW").val(); // Find the text
        var w = parseFloat($text);
        if (w == 0) {
            w = -1;
        }
        if (w < 0) {
            w = -1;
        } if (w == -1) {
            w = -1;
        } if (w > 0) {
            w += -10;
        }
        $row.find(".nr_REVIEW").val(w);

        var kh_id = $row.find("td:eq(1) input:nth-child(1)").val();
        var khach_id = $row.find("td:eq(1) input:nth-child(2)").val();
        var tyle = $row.find("td:eq(5) input").val();
        var tylerw = $row.find("td:eq(8) input").val();

        UpdateTaget(kh_id,khach_id,tyle,tylerw);
    });

    $("#TARGET_BRAND").keypress(function(e){
        if (e.which == 13) {
            var Id = $('#KH_BANHANG_ID').val();
            var target = $(this).val();
            var ghichu = $('#GHICHU').val();
            $.ajax({
                type: "POST",
                url: "/CRM_KH_BANHANG/UpdateTarget",
                data: JSON.stringify({ id: Id, target: target, ghichu: ghichu}),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (r) { }
            });
        }
    });

    $("#GHICHU").keypress(function(e){
        debugger
        if (e.which == 13) {
            var Id = $('#KH_BANHANG_ID').val();
            var target = $('#TARGET_BRAND').val();
            var ghichu = $(this).val();
            $.ajax({
                type: "POST",
                url: "/CRM_KH_BANHANG/UpdateTarget",
                data: JSON.stringify({ id: Id, target: target, Note: ghichu}),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (r) {

                    alert("Lưu thành công");
                }
            });
        }
    });

    $(".trangthai").click(function(e){
        var color = $( this ).html();
       // alert(color);
        //$("table tbody tr").hide();
        //if(color == 'Từ chối'){

        //}
        //$('table tbody tr td:contains("' + value + '")').parent('tr').show();
        //var value = $(this).val().trim();
        //if (value != '') {
        //    $("table tbody tr").hide();
        //} else {
        //    $("table tbody tr").show();
        //}
        //$('table tbody tr td:contains("' + value + '")').parent('tr').show();
    });
</script>