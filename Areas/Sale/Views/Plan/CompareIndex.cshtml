@model List<IndexViewModel>
@using Erp.BackOffice.Areas.Cms.Models
@using Erp.BackOffice.App_GlobalResources
@using Erp.BackOffice.Sale.Models
@using Erp.BackOffice.Helpers
@using GridMvc.Html
@using PagedList;
@using PagedList.Mvc;
@{
    ViewBag.Title = "Báo cáo so sánh chỉ số";
    Layout = "~/Views/Shared/ACE_AdminLayout.cshtml";
    Erp.BackOffice.Models.PageSetting pageSetting = new Erp.BackOffice.Models.PageSetting
    {
        ModuleName = "Plan",
        ActionName = "CompareIndex",
        PageTitle = ViewBag.Title,
        DisplaySearchPanel = true,
        IsPopup = false,
        DisplayBackButton = false,
        AdvancedSearch = false,
        //SearchOjectAttr = ViewBag.ListOjectAttrSearch
    };



    string Month = Request["month"] != null ? Request["month"] : DateTime.Now.Month.ToString();
    string Year = Request["year"] != null ? Request["year"] : DateTime.Now.Year.ToString();
    IEnumerable<Erp.BackOffice.Areas.Administration.Models.UserViewModel> user = (IEnumerable<Erp.BackOffice.Areas.Administration.Models.UserViewModel>)ViewBag.user;
    DateTime aDateTime = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
    // Cộng thêm 1 tháng và trừ đi một ngày.
    DateTime retDateTime = aDateTime.AddMonths(1).AddDays(-1);
    IEnumerable<CategoryViewModel> origin = (IEnumerable<CategoryViewModel>)ViewBag.category;
    var oldcus = ViewBag.OldCustomer;
    var NEW = oldcus == 1 ? false : true;

}

@helper GridColumnschedule(int id, string code)
{
    <a href="@Url.Action("Detail", "Customer", new {Area = "Account", Id = id })">@code</a>
}
@helper GridTuongtac(int? id, string NgayLap, int? nvkd)
{

    @*<a target="_blank" href='@Url.Action("LichSuTuongTac", "Plan", new { NGUOILAP_ID=nvkd,KHACHHANG_ID=id})'>@NgayLap</a>*@
    <a onclick="OpenPopup('@Url.Action("LichSuTuongTac", "Plan", new {NGUOILAP_ID=nvkd,KHACHHANG_ID= id , IsPopup = true })', '', 0, 0)">@NgayLap</a>

}

@using (Html.BeginPageHeaderContainer(pageSetting))
{

    <select class="chzn-select" style="width:250px; float:left" id="UserId" name="UserId">
        <option value="">- Nhân viên QL -</option>
        @foreach (var item in SelectListHelper.GetSelectList_FullUserNameKD(null, null))
                {
            <option @(Request["UserId"] == item.Value ? "Selected" : "") value="@item.Value">@item.Text</option>
        }
    </select>
    <span class="input-daterange input-group" style="z-index:1002">
        @Html.TextBox("startDate", Request["startDate"] != null ? Request["startDate"] : aDateTime.ToString("dd/MM/yyyy"), new { autocomplete = "off", placeholder = "Từ ngày" })
        <span class="input-group-addon">
            <i class="fa fa-exchange"></i>
        </span>
        @Html.TextBox("endDate", Request["endDate"] != null ? Request["endDate"] : retDateTime.ToString("dd/MM/yyyy"), new { autocomplete = "off", placeholder = "Đến ngày" })
    </span>

    <label>
        <input type="radio" class="hidden-320 ace ng-valid ng-dirty" id="single1" @(oldcus == 2 ? "checked" : "") name="OldCustomer" value="2">
        <span class="lbl ng-binding">Khách mới </span>
    </label>
    <label>
        <input type="radio" class="hidden-320 ace ng-pristine ng-valid" id="single2" @(oldcus == 1 ? "checked" : "") name="OldCustomer" value="1">
        <span class="lbl ng-binding">Khách cũ </span>
    </label>

    <button class="btn btn-mini btn-success" type="button" id="bieudo" name="bieudo">Xem biểu đồ</button>
    @*@Html.DropDownList("HINHTHUC_TUONGTAC", Erp.BackOffice.Helpers.SelectListHelper.GetSelectList_Category("HINHTHUC_GIOITHIEU", Request["HINHTHUC_TUONGTAC"], "-Hình thức-"), new { style = "width: 150px;/* padding-right: 0px; */margin-right: 100px;margin-left:1px;" })*@

}

<div class="table-responsive">
    <table class="table-responsive table table-bordered" id="cTable">
        <thead>
            <tr>
                <td></td>
                @foreach (var item in user)
                {
                    <td>@item.FullName</td>
                }
            </tr>
        </thead>
        <tbody>
            @if (NEW == true)
            {
                <tr>
                    <td>SL TƯƠNG TÁC MỚI</td>
                    @foreach (var item in Model)
                {
                        <td>@item.TT</td>
                    }
                </tr>
                <tr>
                    <td>SỐ LƯỢNG KHÁCH MỚI HẸN</td>
                    @foreach (var item in Model)
                {
                        <td>@item.Hen</td>
                    }
                </tr>
                <tr>
                    <td>SỐ LƯỢNG KHÁCH MỚI LÊN</td>
                    @foreach (var item in Model)
                {
                        <td>@item.Len</td>
                    }
                </tr>
                <tr>
                    <td>SỐ LƯỢNG KHÁCH MỚI MUA</td>
                    @foreach (var item in Model)
                {
                        <td>@item.Mua</td>
                    }
                </tr>
                <tr>
                    <td>TỶ LỆ LÊN TRÊN HẸN</td>
                    @foreach (var item in Model)
                {
                        <td>@((float)((float)item.Len / (float)(item.Hen != null? item.Hen: 1))* 100) %</td>
                    }
                </tr>
                <tr>
                    <td>TỶ LỆ MUA TRÊN LÊN MỚI</td>
                    @foreach (var item in Model)
                {
                        <td>@((float)((float)item.Mua/(float)item.Len) * 100) %</td>
                    }
                </tr>
                <tr>
                    <td>DOANH SỐ ẢO MỚI</td>
                    @foreach (var item in Model)
                {
                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(item.Ao)</td>
                    }
                </tr>
                <tr>
                    <td>DOANH SỐ THỰC MỚI</td>
                    @foreach (var item in Model)
                {
                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(item.Thuc)</td>
                    }
                </tr>
                <tr>
                    <td>TB HĐ ẢO MỚI</td>
                    @foreach (var item in Model)
                {
                    var Tb = item.Ao / ((item.Mua != null && item.Mua != 0) ? item.Mua : 1);
                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(Tb) </td>
                    }
                </tr>
                <tr>
                    <td>TB HĐ THỰC MỚI</td>
                    @foreach (var item in Model)
                    {
                        var Tb = item.Thuc / ((item.Mua != null && item.Mua != 0) ? item.Mua : 1);
                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(Tb) </td>
                    }
                </tr>
            }
            else
            {

                <tr>
                    <td>SL TƯƠNG TÁC CŨ</td>
                    @foreach (var item in Model)
                {
                        <td>@item.TT</td>
                    }
                </tr>
                <tr>
                    <td>SỐ LƯỢNG KHÁCH CŨ HẸN</td>
                    @foreach (var item in Model)
                {
                        <td>@item.Hen</td>
                    }
                </tr>
                <tr>
                    <td>SỐ LƯỢNG KHÁCH CŨ LÊN</td>
                    @foreach (var item in Model)
                {
                        <td>@item.Len</td>
                    }
                </tr>
                <tr>
                    <td>SỐ LƯỢNG KHÁCH CŨ MUA</td>
                    @foreach (var item in Model)
                {
                        <td>@item.Mua</td>
                    }
                </tr>
                <tr>
                    <td>TỶ LỆ LÊN TRÊN HẸN</td>
                    @foreach (var item in Model)
                {
                        <td>@((float)((float)item.Len / (float)(item.Hen != null ? item.Hen : 1)) * 100) %</td>
                    }
                </tr>
                <tr>
                    <td>TỶ LỆ MUA TRÊN LÊN CŨ</td>
                    @foreach (var item in Model)
                {
                        <td>@((float)((float)item.Mua/(float)item.Len)*100) %</td>
                    }
                </tr>
                <tr>
                    <td>DOANH SỐ ẢO CŨ</td>
                    @foreach (var item in Model)
                {
                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(item.Ao)</td>
                    }
                </tr>
                <tr>
                    <td>DOANH SỐ THỰC CŨ</td>
                    @foreach (var item in Model)
                {
                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(item.Thuc)</td>
                    }
                </tr>
                <tr>
                    <td>TB HĐ ẢO CŨ</td>
                    @foreach (var item in Model)
                {
                    var Tb = item.Ao / item.Mua;
                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(Tb) </td>
                    }
                </tr>
                <tr>
                    <td>TB HĐ THỰC CŨ</td>
                    @foreach (var item in Model)
                    {
                        var Tb = item.Thuc / item.Mua;
                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(Tb) </td>
                    }
                </tr>
                <tr>
                    <td>TỔNG ORLANE ẢO</td>
                    @foreach (var item in Model)
                    {
                     
                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(item.AoOrlane) </td>
                    }
                </tr>
                <tr>
                    <td>TỔNG ORLANE THỰC</td>
                    @foreach (var item in Model)
                    {

                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(item.ThucOrlane) </td>
                    }
                </tr>
                <tr>
                    <td>DS ẢO ANNAYAKE</td>
                    @foreach (var item in Model)
                    {

                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(item.AoAnna) </td>
                    }
                </tr>
                <tr>
                    <td>DS THỰC ANNAYAKE</td>
                    @foreach (var item in Model)
                    {

                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(item.ThucAnna) </td>
                    }
                </tr>
                <tr>
                    <td>DS ẢO LEONOR GREYL</td>
                    @foreach (var item in Model)
                    {

                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(item.AoLeo) </td>
                    }
                </tr>
                <tr>
                    <td>DS THỰC LEONOR GREYL</td>
                    @foreach (var item in Model)
                    {

                        <td>@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(item.ThucLeo) </td>
                    }
                </tr>
            }

        </tbody>
    </table>

</div>

<div id="divbieudo"></div>
@using (Html.BeginButtonContainer(pageSetting))
{
    <a class="btn btn-white btn-success btn-sm" type="button" value="Export" href="@Url.Action("ExportCompareIndex","Plan", new { @Area = "Sale"})">
        <i class="ace-icon fa fa-file-excel-o"></i>
        Xuất excel
    </a>
    @*<a>Tổng KHBH:</a> <input type="text" readonly align="right" size="10" id="tongtien" style="color:red" value="@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(ViewBag.TONGKHBH)" name="tongbh" />
        <a>Tổng thực KHBH:</a> <input type="text" readonly align="right" size="10" id="tongtien" style="color:red" value="@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(ViewBag.TONGTHUCKHBH)" name="tongthucbh" />
        <a>Tổng KHCDS:</a> <input type="text" readonly align="right" size="10" id="tongthu" style="color:lightseagreen" value="@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(ViewBag.TONGKHDS)" name="tongds" />
        <a>Tổng thực KHCDS:</a> <input type="text" readonly align="right" size="10" id="tongthu" style="color:lightseagreen" value="@Erp.BackOffice.Helpers.Common.PhanCachHangNgan2(ViewBag.TONGTHUCKHDS)" name="tongthucds" />*@
}
<script src="~/Scripts/jquery.table.marge.js"></script>

<script>
    //$('.table').margetable({
    //    type: 1,
    //    colindex: [{
    //        index: 5,
    //        dependent: [0,4]
    //    }]
    //});

    //$('.table').margetable({
    //    type: 1,
    //    colindex: [{
    //        index: 8,
    //        dependent: [0, 4]
    //    }]
    //});

    //$('.table').margetable({
    //        type: 2,
    //colindex: [0] // column 1, 2
    //});
</script>

@section Scripts {

    @*@Html.ScriptBottom_ChosenStyle()*@

    <script type="text/javascript">
        $("button[name='bieudo']").click(function (e) {
            var UserId = $("#UserId").val();
            var startDate = $("#startDate").val();
            var endDate = $("#endDate").val();
            var OldCustomer = $("input[name='OldCustomer']:checked").val();
            //var OldCustomer = $("#endDate").val();
            $.get('@Url.Action("BieuDoChiSoTuan", "Plan", new { area = "Sale" })/?UserId=' + UserId + '&startDate=' + startDate + '&endDate=' + endDate + '&OldCustomer=' + OldCustomer, function (html) {
                $("#divbieudo").html(html);
                $(".table-responsive").hide();
            });
        });
    </script>
    @Html.ScriptBottom_ValidationMvc()
    @Html.ScriptBottom_DatePicker("dd/MM/yyyy")
}