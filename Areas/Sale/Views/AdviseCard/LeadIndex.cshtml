<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/js/bootstrap-datepicker.min.js"></script>

@using Erp.BackOffice.App_GlobalResources
@using Erp.BackOffice.Sale.Models
@using Erp.BackOffice.Sale.Controllers
@using Erp.BackOffice.Helpers
@using GridMvc.Html
@using Erp.BackOffice.Sale.Models
@using System.ComponentModel

@{
    ViewBag.Title = "Lead";
    bool isPopup = Request["IsPopup"] != null && Request["IsPopup"].ToString().ToLower() == "true" ? true : false;
    if (isPopup)
    {
        Layout = "~/Views/Shared/_PopupLayout.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/ACE_AdminLayout.cshtml";
    }

    var jsCallback = Request["jsCallback"] == null ? "" : Request["jsCallback"].ToString();

    Erp.BackOffice.Models.PageSetting pageSetting = new Erp.BackOffice.Models.PageSetting
    {
        ModuleName = "AdviseCard",
        ActionName = "LeadIndex",
        PageTitle = ViewBag.Title,
        DisplaySearchPanel = true,
        IsPopup = false,
        DisplayBackButton = false
    };
    int? ldcusview = ViewBag.ldcusview;
}
@*hau them*@
<style>

    .body-content {
        height: 85vh !important;
    }

    .loading {
        cursor: progress;
    }



    .modal-body input, .select2-container {
        margin-bottom: 10px !important;
    }

    .table-hover > tbody > tr:hover, .table > tbody > tr.active > td, .table > tbody > tr.active > th, .table > tbody > tr > td.active, .table > tbody > tr > th.active, .table > tfoot > tr.active > td, .table > tfoot > tr.active > th, .table > tfoot > tr > td.active, .table > tfoot > tr > th.active, .table > thead > tr.active > td, .table > thead > tr.active > th, .table > thead > tr > td.active, .table > thead > tr > th.active {
        background-color: #eaf4fd !important;
    }


    .btn-default2, #btnCloseAdd, #QuickEditLeadDisable, #btnLeadDelete {
        border: 2px solid #b7bbd2;
        background-color: #b7bbd2 !important;
        color: #fff !important;
        font-weight: bold;
        border-radius: 3px;
    }

        .btn-default2:hover, #btnCloseAdd:hover, #QuickEditLeadDisable:hover, #btnLeadDelete:hover {
            opacity: 0.8;
        }

    .btn-primary2, #saveLeadModal, #QuickEditLead, #QuickEditLeadEnable {
        border: 2px solid #3F51B5;
        background-color: #3f51b5 !important;
        color: #ffffff !important;
        font-weight: bold;
        border-radius: 3px;
        padding: 5px 20px !important;
    }

    #btnLeadOpenPpAssign {
        /*   border: 2px solid #48D1CC;
        background-color: #20B2AA !important;*/
        /*    color: #3f51b5 !important;
        font-weight: bold;*/
        border-radius: 3px;
        padding: 5px 12px !important;
    }

    #btnLeadexitoption {
        border: 2px solid #FF6347;
        background-color: #FF0000 !important;
        color: #ffffff !important;
        font-weight: bold;
        border-radius: 3px;
        padding: 5px 20px !important;
    }

        .btn-primary2:hover, #saveLeadModal:hover, #QuickEditLead:hover, #QuickEditLeadEnable:hover, #btnLeadOpenPpAssign:hover, #btnLeadexitoption:hover {
            opacity: 0.8;
        }

    #SubLeadLogsShow {
        margin-top: 10px !important;
    }

    .modal-body section {
        border: unset !important;
    }

    section h4 {
        margin-bottom: -10px !important;
        font-weight: bold;
    }

    #addNewContent {
        padding-left: 0px !important;
    }

    #LeadLogsShow > div:first-child {
        margin-top: 20px !important;
    }

    .modal-header, #StatusHeader, #select2parent, #TabLeadHeader {
        background: #7ea3c321
    }

    .modal-body section {
        margin-bottom: 20px;
        background: #fff;
        padding: 15px 30px !important;
    }

    #myDiv .btn-header-cmt:hover {
        background-color: #60c9f8 !important;
        color: #fff !important;
    }

    #submyDiv {
        height: 5px;
        background-color: #f1f1f1 !important;
        position: absolute;
        z-index: 1;
        margin-left: 10px;
        margin-top: -10px;
    }

    .btn.active.focus, .btn.active:focus, .btn.focus, .btn:active.focus, .btn:active:focus, .btn:focus {
        outline: unset !important;
    }

    #myDiv {
        background: #fff;
        padding: 10px 10px 0 0;
    }

        #myDiv .active {
            border-bottom: 4px solid blue !important;
            background-color: #fff !important;
            color: blue !important;
            font-weight: bold;
            z-index: 2;
        }

    .btn-header-cmt {
        border-top: unset;
        border-left: unset;
        border-right: unset;
        margin: 0 !important;
        background-color: #fff !important;
        border-color: #fff !important;
        color: #000 !important;
        width: 10%;
    }

    .bg-info {
        background-color: #03a9f4a1;
    }

    #StatusHeader label:hover {
        background-color: #64da69cc !important;
        transform-origin: left;
        width: fit-content !important;
        clip-path: polygon(0% 0%, 100% 0%, 100% 50%, 100% 100%, 0 100%) !important;
        box-shadow: inset 200px 0em 0 0 #64da6954;
        font-weight: bold;
        border-radius: 5px;
    }

    #StatusHeader label {
        width: 5% !important;
        /* background-color: #03a9f4a1 !important;*/
        padding: 5px;
        transition: all 1s;
        text-transform: uppercase;
        border-radius: 5px;
        margin-left: -4px;
    }

    .table > tbody > tr > td, .table > tbody > tr > th, .table > tfoot > tr > td, .table > tfoot > tr > th, .table > thead > tr > td, .table > thead > tr > th {
        border-right: unset;
    }

    #muc-luc li:hover {
        background: #12e4ff;
    }

    #muc-luc ul {
        text-transform: uppercase;
        white-space: nowrap;
        overflow: hidden;
        width: 100%;
        margin: 0 !important;
    }

    #muc-luc li {
        padding: 5px 0;
        border-bottom: 1px solid #0000002b;
        margin: 0 !important;
        padding-left: 10px;
    }

    #searchInputForm span {
        height: 86% !important;
        background: #12e4ff;
        display: inline-table;
        border-radius: 3px;
        margin: 0 2px;
        padding-left: 5px;
    }

    #searchInputForm button {
        height: 100%
    }

    #searchInputForm {
        display: flex;
        align-items: center;
    }

    #SearchLeadForm {
        box-shadow: 0px 0px 15px #000;
    }

    .width-34 {
        width: 34%;
    }

    section label {
        color: #3F51B5;
    }

    .custom-class {
        color: #3f4d9d;
        vertical-align: middle;
    }

    .modal-open .modal {
        overflow-y: unset;
    }

    #muc-luc {
        border-right: 1px solid #337ab7;
        width: 35%;
    }

    .select2-container {
        width: 100% !important;
    }

    .content {
        width: 80%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    #searchPanelContent {
        display: flex;
        height: 540px;
        overflow: hidden;
        padding-right: 0px;
        padding-left: 0px;
    }

    #btnAdd {
        position: sticky;
        bottom: 0% !important;
    }

    .select2-container .select2-selection--multiple .select2-selection__rendered {
        display: block !important;
    }

    @@media (max-width : 1480px) {
        #modal-search {
            left: 75px !important;
            width: 50% !important;
        }

        .content {
            width: 90%;
        }
    }

    @@media (max-width : 1440px) {
        #modal-search {
            left: 18px !important;
            width: 44% !important;
        }
    }


    @@media (max-width : 1440px) {
        #modal-search {
            left: 120px !important;
            width: 44% !important;
        }

        .content {
            width: 65%;
        }

        .width-34 {
            width: 80%;
            margin-bottom: 10px;
        }
    }

    #searchPanelContent input {
        border: 1px solid;
        margin-right: 10px;
    }

    .modal-backdrop.in {
        display: none;
    }

    .table > thead:first-child > tr:first-child > th {
        background: #fff;
        color: #152cad !important;
    }

    .btn-success, .btn-success.focus, .btn-success:focus {
        background-color: rgba(255, 255, 255, 0.2) !important;
        border-color: #fff !important;
        border: 0px solid !important;
    }

    .btn-search, .btn-setting {
        display: inline-block;
        float: left;
        width: 33px;
        height: 24px;
        cursor: pointer;
        background: url('/assets/img/btn_title_right.gif') no-repeat;
        margin: 0px;
        margin-left: -33px;
    }

    .btn-search {
        background-position: -1px -24px;
    }

        .btn-search:hover {
            background-position: -35px -24px;
        }

    .btn-setting:hover {
        background-position: -34px 0px;
    }

    .tag-container {
        display: inline-block;
        /*            border: 1px solid #ccc;*/
        padding: 5px;
    }

        .tag-container span {
            background-color: #f0f0f0;
            padding: 3px 5px;
            margin-right: 5px;
            border-radius: 3px;
        }

    #btnSearchLead, #btnCloseSearch, #saveLeadModal, #btnCloseAdd {
        margin: 0;
        border-radius: 3px;
        padding: 3px 20px;
    }

    #saveLeadModal {
        margin-left: 20px;
        padding: 3px 25px !important;
    }

    #searchPanelContent span {
        background-color: unset;
        /* width:200px;*/
    }

    .select2-results__option[aria-selected] {
        background: #fff;
    }

    /*thanh*/
    .nav-item {
        align-self: center !important;
    }

        .nav-item .active {
            background-color: rgba(255, 255, 255, 0.2) !important;
        }

    .nav-link {
        padding: 5px 15px !important;
        color: white !important;
    }

        .nav-item:hover,
        .nav-link:hover {
            background-color: #629B58 !important;
            border-radius: 4px;
        }

    form#QuickEditLeadForm {
        overflow: auto !important;
        height: 54rem !important;
    }


    html {
        scrollbar-width: none;
    }

    /*[H-Nam]*/
    .info-header {
        width: 10rem;
        text-transform: capitalize;
    }
</style>
@*end*@


<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.css" integrity="sha512-3pIirOrwegjM6erE5gPSwkUzO+3cTjpnV9lexlNZqvupR64iZBnOOTiiLPb9M36zpMScbmUNIcHUqKD47M719g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<nav class="navbar navbar-default">
    <div style="display: flex !important; align-items: center;" class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div style="margin: 0 20px; display: flex;" class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand info-header" href="#" style="font-size: 21px !important;">@(ldcusview==-1?"Cơ hội":"Lead")</a>
            <div class="navbar-brand" id="countLead" style="font-size: 17px !important; color: #dbdbdb"></div>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div style="display: flex !important; align-items: center;width:100% " class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav"></ul>

            <form style="width: 100%; text-align: left; display: flex; align-items: center;" class="navbar-form text-center">
                <div style="width: 100%; text-align: left; display: flex; align-items: center; " class="form-group">
                    <input style="width:80%;border-radius:3px !important; padding-left:20px;" type="text" id="searchInput" class="form-control" placeholder="Bộ lọc và tìm kiếm" readonly>
                    <label class="btn-search" href="#" data-action="collapse" for="searchInput">
                        <i class="ace-icon fa"></i>
                    </label>
                    <div style=" position: absolute; top: 18%; width: 55%; height: 64%; overflow: hidden;">
                        <div id="searchInputForm" style="width: 2000px; height:100%;">
                        </div>

                    </div>
                </div>
                @*<button style="border-radius: 10px !important" id="searchButton" type="submit" class="btn btn-default">Tìm kiếm</button>*@

            </form>


            <ul class="nav nav-pills" style="display: flex; width: 20%; ">
                <li class="nav-item">
                    <a class="nav-link" data-id="0" href="#">List</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-id="1" href="#">Kanban</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li style="margin-bottom:5px;border:none;outline:none;display: inline-flex; align-items: center;cursor: pointer;">
                    <button type="button" id="addNew" onclick="addNew()" style="border-radius: 10px !important; padding: 6px 20px; " class="btn btn-success" data-toggle="modal" data-target=".bs-example-modal-sm">
                        Thêm mới
                    </button>
                    <button style="display: none; border-radius: 10px !important" type="button" id="searchPanel" onclick="searchPanel()" class="btn btn-success" data-toggle="modal" data-target=".bs-searchPanel-modal-sm"></button>
                    <div class="dropdown-modal" style="margin-left:3px" id="idclickdropdodwn">
                        <a data-toggle="dropdown" href="#" class="dropdown-toggle" aria-expanded="false" style="padding: 7px">
                            <i class="fa fa-ellipsis-v" style="color:white; font-size:20px" aria-hidden="true"></i>
                        </a>
                        <ul class=" dropdown-menu-right dropdown-menu dropdown-yellow dropdown-close" style="border-radius: .5rem !important;">
                            <li style="background:white">
                                <a href="javascript:;" onclick="OpenPopup('/ImportExcel/SetupImport?ldleadview='+'@ldcusview', 'Nhập dữ liệu từ Excel', 900, 450)">
                                    <img src="~/assets/img/import.png" style="width: 2rem;" alt="Alternate Text" />
                                    Nhập từ Excel
                                </a>
                            </li>

                        </ul>

                    </div>
                </li>
            </ul>

        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>
<div id="LeadTbl" style="min-height: 85vh;">

</div>

<!-- Modal content -->
<!-- Z-Index để ẩn NavBar -->
<div style="z-index: 1030; height: 110%; padding-left: 0px;" id="addNewContent" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
    @*<div class="modal-dialog modal-sm frameright" style="left:0%;right:50%;position:absolute;width:50%" role="document">
            <div id="addNewContent" class="modal-content">


            </div>
        </div>*@
</div>
<!-- Modal content -->
<div style="top: 83px; z-index: 99999 !important; display: 0;" class="modal fade bs-searchPanel-modal-sm" id="Modelid" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
    <div id="modal-search" class="modal-dialog modal-sm" style="left: 50px; right: 0%; position: absolute; width: 50%; top: -31px; " role="document">
        <div class="modal-content">
            <!-- Modal header -->
            <div style="display:none" class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">Tìm kiếm</h4>
            </div>
            <form id="SearchLeadForm" action="/AdviseCard/SearchLead" method="post">

                <!-- Modal body -->
                <div id="searchPanelContent" class="modal-body"></div>
                <!-- Modal footer -->

                <div style="position: sticky; bottom: 20px;" class="modal-footer">

                    <button id="btnCloseSearch" type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                    <button id="btnSearchLead" type="button" class="btn btn-primary">Tìm kiếm</button>
                </div>
            </form>

        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>

    $("#searchInput").on('focus', function () {

        var x = document.getElementById("Modelid");
        if (x.style.display === "none") {
            x.style.display = "block";
        } else {
            x.style.display = "none";
        }
        if ($('#searchPanelContent').html() != '') {
            $('.bs-searchPanel-modal-sm').modal()
        } else {
            $("#searchPanel").trigger("click")
        }
    }); $("#searchInputForm").on('click', function (e) {
        if (e.target !== this)
            return;
        $("#searchInput").trigger("focus")
    });
    function addNew() {
        /*debugger*/
        $.ajax({
            url: "/AdviseCard/AddNewModal?type=1&ldcusview="+'@ldcusview',
            method: "get",
            dataType: "html",
            success: function (data) {
                $("#addNewContent").html(data);
                $('#IdLead').val(0);
                //$('#btnAdd').css('display', 'block')
                $('#UserIdZalo').hide();
                $('#CountForBrand').hide();
            }
        })
    }
    function searchPanel() {
        /* debugger*/
        $.ajax({
            url: "/AdviseCard/AddNewModal?type=0&ldcusview="+'@ldcusview',
            method: "get",
            async: false,
            dataType: "html",
            success: function (data) {
                $("#searchPanelContent").html(data)
            }
        })
    }
    function DetailLead(Id) {
        $('body').addClass('loading')
        $.ajax({
            url: "/AdviseCard/DetailLeadModal?Id=" + Id +"&isPartial="+'@ldcusview',
            method: "get",
            dataType: "html",
            success: function (data) {
                $("#addNewContent").html(data)
                $('#IdLead').val(Id)
                $('.bs-example-modal-sm').modal()
                $('#meetingContent2').html('');
                typeof (selectedId) == 'object' ? selectedId=[] : ''
                //$('#btnAdd').css('display','none')
            },
            complete: function () {
                $('body').removeClass('loading')

            }
        })
    }

    function triggerbtnCloseSearch() {
        document.getElementById("btnCloseSearch").click();
    }


    $('#btnSearchLead').click(function () {
        triggerbtnCloseSearch();
        let cookiepg = getCookieLeadIndex('ListOrKanbanId');
        if (cookiepg == 0) {
            let cookie = getCookieLeadIndex('pageSize')
            SearchLeadFunc(1, cookie);
            CountLead();
        } else {
            callKanban(0);
        }

        triggerbtnCloseSearch();
    })


    $('#btnCloseSearch').click(function () {
        //alert("okokokok");
        var x = document.getElementById("Modelid");
        if (x.style.display === "none") {
            //x.style.display = "block";
        } else {
            x.style.display = "none";
        }
    })


    function SearchLeadFunc(pageNumber, pageSize) {
        debugger
        ShowLoading();
        var formData = new FormData($('#SearchLeadForm')[0]);
        formData.append('pageNumber', pageNumber);
        formData.append('pageSize', pageSize);
        formData.append('ldcusview', '@ldcusview');
        $.ajax({
            type: "POST",
            url: $('#SearchLeadForm')[0].action,
            data: formData,
            processData: false,
            contentType: false,
            /*  async: false,*/
            dataType: "html",
            success: function (data, textStatus, jqXHR) {
                $('#LeadTbl').html(data)
                /*  $('.js-example-basic-single').select2();*/
                $("#btnCloseSearch").trigger("click");
                CountLead();
            },
            error: function (data, textStatus, jqXHR) {
                toastr.warning('Xảy ra lỗi!')
            },
            complete: function () {
                /*debugger*/
                HideLoading();
                setCookie("pageNumber", pageNumber, 65);
            }
        })
    }

    function SearchLeadFuncs(pageNumber, pageSize, columnsort, sortdir) {
        ShowLoading();
        var formData = new FormData($('#SearchLeadForm')[0]);
        formData.append('pageNumber', pageNumber);
        formData.append('pageSize', pageSize);
        formData.append('columnsort', columnsort);
        formData.append('sortdir', sortdir);
        formData.append('ldcusview', '@ldcusview');
        $.ajax({
            type: "POST",
            url: $('#SearchLeadForm')[0].action,
            data: formData,
            processData: false,
            contentType: false,
            dataType: "html",
            success: function (data, textStatus, jqXHR) {
                $('#LeadTbl').html(data)
                $("#btnCloseSearch").trigger("click")
            },
            error: function (data, textStatus, jqXHR) {
                toastr.warning('Xảy ra lỗi!')
            },
            complete: function () {
                HideLoading();
            }
        })
    }
    function getCookieLeadIndex(name) {
        /*debugger*/
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        else {
            if (name == "pageSize") {
                return 15;
            } else
                return 0;
        }
    }
    function setCookie(name, value, days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }
    function callKanban(scrollLeft) {
        /* debugger;*/
        ShowLoading();
        var formData = new FormData($('#SearchLeadForm')[0]);
                formData.append('ldcusview', '@ldcusview');
        $.ajax({
            url: '/AdviseCard/SearchLeadKanban',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            /*  async: false,*/
            dataType: "html",
            success: function (data) {
                /* debugger;*/
                $("#LeadTbl").html(data);
                $(".body-content").scrollLeft(scrollLeft);
                $("#btnCloseSearch").trigger("click");
            },
            error: function (data, textStatus, jqXHR) {
                toastr.warning('Xảy ra lỗi!');
            },
            complete: function () {
                /* debugger*/
                HideLoading();
            }
        });
    }
    function fnDeleteLead(arr) {
        $.ajax({
            url: "/AdviseCard/DeleteLead",
            method: "post",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(arr),
            dataType: "json",
            success: function (data) {
                if (data > 0) {
                    toastr.success('Xóa thành công!')
                    let cookie = getCookieLeadIndex('pageSize')
                    SearchLeadFunc(1, cookie)
                } else {
                    toastr.warning('Xóa thất bại!')
                }
            }
        })
    }
    $(document).ready(function () {
        /* debugger;*/
        $('#muc-luc ul li').click(function () {
            window.location = $('a', this).attr('href');
        });
        searchPanel()
        let cookiepg = getCookieLeadIndex('ListOrKanbanId');
        if (cookiepg == 0) {
            $(".nav-link[data-id='0']").addClass("active");

            let cookie = getCookieLeadIndex('pageSize')
            SearchLeadFunc(1, cookie)
        } else {
            $(".nav-link[data-id='1']").addClass("active");
            callKanban();
        }
        CountLead();
        $(document).on('click', '#btnLeadDelete', function () {
            /* debugger*/
            Swal.fire({
                title: 'Bạn có chắc chắn muốn xóa những Lead này không?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Không'
            }).then((result) => {
                if (result.isConfirmed) {
                    var ele = $('#LeadTblR').find('.checkbox.child:checked')
                    let arr = []
                    $.each(ele, function (idx, item) {
                        arr.push(parseInt($(this).parent().prev().text()))
                    })
                    fnDeleteLead(arr);
                } else {

                }
            })
        })
        $(document).on('click', '#QuickEditLead', function () {
            debugger
            var emailCheck = false;
            var mobileCheck = false;
            var chkele = $('#LeadTblR').find('.checkbox.child').filter(':checked').filter(function () {
                return $(this).closest('tr').css('display') !== 'none';
            });;

            $.each(chkele, function () { //Kiểm tra email và mobile nhập chuẩn hoặc không nhập
                let emailInputs = $(this).parent().parent().find("input[name*='Email']");
                //let emailF13 = $(this).parent().parent().find("input[name*='F13']");
                //const emailF13Arr = Array.from(emailF13);
                //if (emailF13Arr.every(x => isValidEmail(x.value))) {
                //    emailCheck = true;
                //} else {
                //    emailCheck = false;
                //    return false;
                //}
                const emailArrays = Array.from(emailInputs);
                if (emailArrays.every(x => isValidEmail(x.value))) {
                    emailCheck = true;
                } else {
                    emailCheck = false;
                    return false;
                }

                let mobileInputs = $(this).parent().parent().find("input[name*='Mobile']");
                const mobileArrays = Array.from(mobileInputs);
                if (mobileArrays.every(x => isValidMobile(x.value))) {
                    mobileCheck = true;
                }
                else {
                    mobileCheck = false;
                    return false;
                }
            })
            if (emailCheck && mobileCheck) {
                debugger;
                var form = new FormData($('#QuickEditLeadForm')[0]);
                form.append("ldcusview",'@ldcusview');
                var ele = $('#LeadTblR').find('.checkbox.child').filter(':checked').filter(function () {
                    return $(this).closest('tr').css('display') !== 'none';
                });;
                let valid = [];
                $.each(ele, function () {
                    valid.push(parseInt($(this).parent().parent().find('td:first').text()));
                });
                for (const a of valid) {
                    form.append("valid", a);
                }
                $.ajax({
                    url: "/AdviseCard/QuickEditLead",
                    method: "post",
                    data: form,
                    processData: false,
                    contentType: false,
                    dataType: "json",
                    beforeSend: function () {
                        ShowLoading();
                    },
                    success: function (data) {
                        // Xử lý kết quả sau khi nhận phản hồi từ server
                        if (data > 0) {
                            let cookie = getCookieLeadIndex('pageSize');
                            SearchLeadFunc(1, cookie);
                            // Hiển thị thông báo sau 1 giây
                            setTimeout(function () {
                                toastr.success('Sửa thành công!');
                            }, 1000);
                        } else {
                            // Hiển thị thông báo sau 1 giây
                            setTimeout(function () {
                                toastr.error('Sửa thất bại!');
                            }, 1000);
                        }
                    },
                    complete: function () {
                        // Ẩn loading sau 1 giây
                        setTimeout(function () {
                            HideLoading();
                        }, 1000);
                    }
                });
            }
            else {
                toastr.warning('Sửa thất bại! Vui lòng kiểm tra lại format của dữ liệu số điện thoại và Email!');
            }
        });

        $(".nav-link").click(function () {
            var isActive = $(this).hasClass("active");
            if (isActive) {
            } else {
                $(".nav-link").removeClass("active");
                $(this).addClass("active");
                var dataId = $(this).attr("data-id");
                setCookie("ListOrKanbanId", dataId, 65);
                if (dataId == 0) {
                    let cookie = getCookieLeadIndex('pageSize');
                    SearchLeadFunc(1, cookie);
                } else {
                    callKanban(0);
                }
            }
        });
    });
    function CountLead() {
        ShowLoading();
        var formData = new FormData($('#SearchLeadForm')[0]);
        formData.append('ldcusview', '@ldcusview');

        $.ajax({
            type: "POST",
            url: '/AdviseCard/GetCountList',
            data: formData,
            processData: false,
            contentType: false,
            dataType: "json",  // Chờ phản hồi là JSON
            success: function (data, textStatus, jqXHR) {
                // Truy cập thuộc tính Count từ phản hồi JSON
                $("#countLead").text(data.Count);
            },
            error: function (data, textStatus, jqXHR) {
                toastr.warning('Xảy ra lỗi!')
            },
        });
    }


</script>

<script src="~/Scripts/jquery.signalR-2.4.3.min.js" type="text/javascript"></script>
<script src="~/signalr/hubs"></script>
<script type="text/javascript">
    var hub = $.connection.erpHub;
    hub.client.f5LeadLogs = function (id) {
        /* debugger*/
        if (id == $('#IdLead').val()) {
            $.ajax({
                url: '/AdviseCard/LeadLogsView?id=' + id,
                method: "get",
                dataType: "html",
                success: function (data) {
                    $('#LeadLogsShow').html(data)
                }
            })

        }
    };
    hub.client.LeadLogsMeeting = function (LeadId) {
        /*debugger*/
        if (LeadId == $('#IdLead').val()) {
            $.ajax({
                url: '/AdviseCard/LeadLogsMeetingView?LeadId=' + LeadId,
                method: "get",
                dataType: "html",
                success: function (data) {
                    $('#LeadLogsMeetingShow').html(data);
                }
            })

        }
    };
    $.connection.hub.start();
    $.connection.hub.disconnected(function () {
        /* debugger*/
        console.log('Connection lost, attempting to reconnect.');
        setTimeout(function () {
            /* debugger*/
            $.connection.hub.start();
        }, 5000); // Retry connection after 5 seconds
    });
</script>
<script>
    function isValidEmail(email) {
        if (email === "") {
            return true;
        }
        var emailRegex = /\S+@@\S+\.\S+/;
        return emailRegex.test(email);
    }

    function isValidMobile(mobile) {
        if (mobile === "") {
            return true;
        }
        var mobileRegex = /^\+?\d+$/;
        return mobileRegex.test(mobile);
    }
</script>


<script>
    //thanh
    var urlParams = new URLSearchParams(window.location.search);
    var detailLeadId = urlParams.get('detailLeadId');
    if (detailLeadId) {
        var url = window.location.href;
        url = url.split('?')[0];
        history.replaceState({}, '', url);
        DetailLead(detailLeadId);
    }
    window.addEventListener('message', eventListenerLeadIndex);
    function eventListenerLeadIndex(event) {
        if (event.data.type === 'downloadFileImportTrung') {
            var url = event.data.data;
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'blob';

            xhr.onload = function () {
                if (xhr.status === 200) {
                    var fileData = xhr.response; // Dữ liệu tệp tin
                    var fileName = event.data.fileName; // Tên file

                    var link = document.createElement('a');
                    link.href = window.URL.createObjectURL(fileData);
                    link.download = fileName;
                    link.click();

                    $.ajax({
                        url: '/CrmTemplateFile/RemoveFile',
                        type: "POST",
                        data: { fileName: event.data.fileName },
                        dataType: 'json',
                        success: function (rs) {
                        }
                    });
                } else {
                    // Xử lý khi có lỗi xảy ra trong quá trình tải xuống
                }
            };
            xhr.send();
        } 
    };
</script>
